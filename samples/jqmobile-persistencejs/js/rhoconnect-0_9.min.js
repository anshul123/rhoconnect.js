var RhoConnect=function(a){function j(g,b){return a.Deferred(function(l){h.storage.loadAllSources(g).done(function(g,e){var m=h.engine.getStartSourceId(e),f={};a.each(e,function(e,n){f[n.name]=n});var s={},d=[];a.each(b,function(f){var n=new a.Deferred;s[f]=n;d.push(n.promise())});a.each(b,function(e,n){var c=f[n.name];if(c){var a=!1;if(c.sync_priority!=n.sync_priority)c.sync_priority=n.sync_priority,a=!0;if(c.sync_type!=n.sync_type)c.sync_type=n.sync_type,a=!0;if(c.associations!=n.associations)c.associations=
n.associations,a=!0;if(!n.id)n.id=c.id;a&&h.storage.storeSource(c,g).done(function(c,f){s[e].resolve(f)}).fail(function(c,f){s[e].reject(c,f)})}else{if(!n.id)n.id=m,m=1;h.storage.insertSource(n,g).done(function(c,f){s[e].resolve(f)}).fail(function(c,f){s[e].reject(c,f)})}});a.when(d).done(function(){l.resolve()}).fail(function(f,n){l.reject(f,n)})}).fail(function(a,e){l.reject(a,e)})}).promise()}function o(g){return a.Deferred(function(b){a.each(g,function(a,g){g.associations=""});a.each(g,function(b,
d){d&&d.model&&d.model.belongsTo&&a.each(d.model.belongsTo,function(e,a){var f=g[a];if(f){var b=f.associations||"";b+=0<b.length?", ":"";b+=d.name+", "+e;f.associations=b}})});h.storage.open().done(function(a){h.storage.rwTx(a).ready(function(a,e){j(e,g).done(function(){b.resolve()}).fail(function(a,f){b.reject(a,f)})}).fail(function(a,e){b.reject(a,e)})})}).promise()}function b(b,k,l){function r(a){if(a&&!a.isLoaded&&(a.isLoaded=!0,"string"==typeof a.name)){var b=new h.domain.Model(a);b.source.sync_priority=
parseInt(a.sync_priority||1E3);b.source.sync_type="incremental";b.source.partition="user";var f=a.source_id?parseInt(a.source_id):null;if((b.source.id=f)&&h.engine.maxConfigSrcId<f)h.engine.maxConfigSrcId=f;d[a.name]=b;h.engine.getSources()[a.name]=b.source}}if(p)return a.Deferred().resolve().promise();k&&"object"==typeof k&&(a.isArray(k)?a.each(k,function(a,b){r(b)}):r(k));p=!0;return o(h.engine.getSources()).done(function(){a.each(h.engine.getSources(),function(a,b){h.engine.getNotify().setNotification(b,
new h.notify.SyncNotification(function(){if("function"==typeof l)return l(a),!1},!1))})})}var d={},p=!1,h={config:a.extend({},{appName:"rhoConnect",syncServer:"",pollInterval:20,database:{nameSuffix:"Db_",version:"1.0",comment:"RhoConnect database",size:2097152}},RhoConfig),EVENTS:{GENERIC_NOTIFICATION:"rhoConnectGenericNotification",ERROR:"rhoConnectError",CLIENT_CREATED:"rhoConnectClientCreated",STATUS_CHANGED:"rhoConnectStatusChanged",SYNCHRONIZING:"rhoConnectSourceSynchronizing",SYNC_SOURCE_END:"rhoConnectSourceSynchronizationEnd"},
getModels:function(){return d},domain:null,protocol:null,engine:null,notify:null,storage:null};return a.extend({ERRORS:{ERR_NONE:"No error",ERR_NETWORK:"Network error",ERR_REMOTESERVER:"Remote server access error",ERR_RUNTIME:"Runtime error",ERR_UNEXPECTEDSERVERRESPONSE:"Unexpected server response",ERR_DIFFDOMAINSINSYNCSRC:"Different synchronization domain error",ERR_NOSERVERRESPONSE:"No server response",ERR_CLIENTISNOTLOGGEDIN:"Client not logged in",ERR_CUSTOMSYNCSERVER:"Custom sync server",ERR_UNATHORIZED:"Unauthorized access",
ERR_CANCELBYUSER:"Canceled by user",ERR_SYNCVERSION:"Synchronization version error",ERR_GEOLOCATION:"Geolocation error"},init:function(g,k,l,r){return a.Deferred(function(a){h.storage.init(r).done(function(){h.engine.restoreSession().done(function(){d={};p=!1;b(k,g,l).done(function(){a.resolve()}).fail(function(b,f){a.reject("models load error: "+f)})}).fail(function(b,f){a.reject("session restoring error: "+f)})}).fail(function(b){a.reject("storage initialization error: "+b)})}).promise()},login:function(b,
d,l,r){return a.Deferred(function(a){h.engine.login(b,d,l,r).done(function(){a.resolve()}).fail(function(b,f){a.reject(b,f)})}).promise()},logout:function(){return h.engine.logout()},isLoggedIn:function(){return h.engine.isSessionExist()},syncAllSources:function(){return h.engine.doSyncAllSources()}},{rho:h})}(jQuery);
(function(a){function j(a){function d(a){window.console&&a(window.console)}function p(d,h){return Date().replace(/\S+\s(.*?)\sGMT\+.*$/,"$1")+" ["+g[d]+"] ("+a+") "+h}var h={trace:0,info:1,warning:2,error:3,fatal:4},g=["Trace","Info","Warning","Error","Fatal"],k="string"==typeof o.config.logLevel&&o.config.logLevel.toLowerCase()in h?h[o.config.logLevel.toLowerCase()]:h.warning;this.trace=function(a){var b=h.trace;k>b||d(function(e){e.info(p(b,a))})};this.info=function(a){var b=h.info;k>b||d(function(e){e.info(p(b,
a))})};this.warning=function(a,b){var e=h.warning;k>e||d(function(g){g.warn(p(e,a));b&&g.warn("EXCEPTION: "+b)})};this.error=function(a,b){var e=h.error;k>e||d(function(g){g.error(p(e,a));b&&g.error("EXCEPTION: "+b)})};this.fatal=function(a,b){var g=h.fatal;k>g||d(function(d){d.error(p(g,a));b&&d.error("EXCEPTION: "+b)})}}var o=RhoConnect.rho;a.extend(o,{Logger:j,ERRORS:RhoConnect.ERRORS,deferredMapOn:function(b){var d={},p=[];a.each(b,function(b){var g=new a.Deferred;d[b]=g;p.push(g.promise())});
return{resolve:function(a,b){d[a]&&d[a].resolve.apply(d[a],b)},reject:function(a,b){d[a]&&d[a].reject.apply(d[a],b)},when:function(){return a.when.apply(this,p)}}},passRejectTo:function(a){return function(){a.reject(arguments)}}});a.extend(RhoConnect,{Logger:j})})(jQuery);
(function(a){function j(a){for(var b=document.cookie.split(";"),d=0;d<b.length;d++){var h=b[d].split("=");if(h[0].replace(/^\s+|\s+$/g,"")==a)return 1<h.length?h[1].replace(/^\s+|\s+$/g,""):""}return null}function o(g,k,l,p){return a.Deferred(function(e){var m=(/\?/.test(g)?"&":"?")+d+"="+h;a.ajax({url:g+(h?m:""),type:l||"post",contentType:p||"application/json",processData:!1,data:a.toJSON(k),dataType:"json",headers:{"X-Origin":function(){var a=document.location;return a.href.substring(0,a.href.length-
a.pathname.length)}()},xhrFields:{withCredentials:!0}}).done(function(a,g,d){b.notify.byEvent(b.EVENTS.GENERIC_NOTIFICATION,g,a,d);e.resolve(g,a,d)}).fail(function(a,g,d){b.notify.byEvent(b.EVENTS.GENERIC_NOTIFICATION,g,d,a);e.reject(g,d,a)})}).promise()}var b=RhoConnect.rho,d="rhosync_session",p={HTTP_OK:200,HTTP_PARTIAL_CONTENT:206,HTTP_MOVED_TEMPORARILY:302,HTTP_MOVED_PERMANENTLY:301,HTTP_MOVED_PERM:301,HTTP_BAD_REQUEST:400,HTTP_NOT_FOUND:404,HTTP_UNAUTHORIZED:401,HTTP_RANGENOTSATISFY:416,HTTP_INTERNAL_ERROR:500,
HTTP_NOTMODIFIED:304},h=null;a.extend(b,{protocol:{getVersion:function(){return 3},getErrCodeFromXHR:function(a){switch(a.status){case p.HTTP_UNAUTHORIZED:return b.ERRORS.ERR_UNATHORIZED;case p.HTTP_OK:return b.ERRORS.ERR_NONE;case p.HTTP_PARTIAL_CONTENT:return b.ERRORS.ERR_NONE;default:return b.ERRORS.ERR_REMOTESERVER}},getSession:function(){return j(d)},setSession:function(){},deleteSession:function(){var a=d,b=window.location.hostname;if(j(a))document.cookie=a+"=; path=/"+(b?"; domain="+b:"")+
"; expires=Thu, 01-Jan-1970 00:00:01 GMT"},getServerQueryUrl:function(){return b.config.syncServer},login:function(g,k){return a.Deferred(function(a){o(b.config.syncServer+"/clientlogin",{login:g,password:k,rememberme:1}).done(function(b,g,k){g&&(h=g[d]||null);a.resolve(g,b,k)}).fail(function(b,d,g){a.reject(b,d,g)})}).promise()},logout:function(){h=null},clientCreate:function(){return o(b.config.syncServer+"/clientcreate","","get","text/plain")},clientReset:function(a){return o(b.config.syncServer+
"/clientreset",{client_id:a},"get","text/plain")},serverQuery:function(a,d,h,p){d="?version=3&client_id="+d+"&p_size="+h;d+=a?"&source_name="+a:"";d+=p?"&token="+p:"";return o(b.config.syncServer+d,"","get","text/plain")},postData:function(a){return o(b.config.syncServer+"",a)}}})})(jQuery);
(function(a){function j(a){this.id=null;this.fields=a.fields;this.values={};var d=!0;this.__defineGetter__("isNew",function(){return d});var p=!1;this.__defineGetter__("isChanged",function(){return p});var h=function(a,b){this.values[a]=b;p=!0};this.addField=function(a){this.__defineGetter__(a,function(){return this.values[a]});this.__defineSetter__(a,function(b){h(a,b)})};this.deleteField=function(a){this.__defineGetter__(a,void 0);this.__defineSetter__(a,void 0);delete this.fields[a];delete this.values[a]};
this.clearNotifications=function(){};this.destroy=function(){};this.updateAttributes=function(){this.save()};this.save=function(){p=d=!1}}var o=RhoConnect.rho;a.extend(o,{domain:{SyncObject:j,Model:function(a){this.source=new o.engine.Source(a.sourceId,a.name,"incremental",o.storage,o.engine,this);this.__defineGetter__("name",function(){return this.source.name});this.__defineSetter__("name",function(a){this.source.name=a});this.belongsTo=a.belongsTo;this.deleteAll=function(){};this.find=function(){};
this.findAll=function(){};this.findBySql=function(){};this.newObject=function(a){return new j(a)};this.createObject=function(a){a=this.newObject(a);a.save();return a};this.paginate=function(){};this.sync=function(){};this.setNotification=function(){};this.save=function(){};this.canModify=function(){}}}})})(jQuery);
(function(a){function j(b,d,g,v){return a.Deferred(function(a){var c=b||l.config.database.name,x=d||l.config.database.version,h=g||l.config.database.comment,k=v||l.config.database.size,m;e[c]||(e[c]={});e[c][x]||(e[c][x]=null);if(m=e[c][x])a.resolve(m);else try{var p=openDatabase(c,x,h,k);e[c]||(e[c]={});m=e[c][x]=p;a.resolve(m)}catch(r){a.reject(r)}}).promise()}function o(b,d){function e(a){var d="function"==typeof a.readTransaction?a.readTransaction:a.transaction;if(b&&b!="read-only")d=a.transaction;
try{d.apply(a,[function(b){v.resolve(a,b)},function(b){n.reject(a,b)},function(){n.resolve(a,"ok")}])}catch(g){n.reject(a,g.message)}}var v=a._Deferred(),n=a.Deferred();d?e(d):j().done(function(a){e(a)}).fail(function(a){n.reject(null,a)});n.promise();n.ready=v.done;return n}function b(b,d,e){return a.Deferred(function(a){function n(c,b,f){c.executeSql(b,f,function(c,b){a.resolve(c,b)},function(c,b){a.reject(c,b)})}if(e)n(e,b,d);else{var c=!b.match(/^\s*select\s+/i);o(c).ready(function(a,c){n(c,b,
d)}).done(function(c,b){a.resolve(c,b)}).fail(function(c,b){a.reject(c,b)})}}).promise()}function d(f,d){function e(a,f){var d=n[c];if(0<f.length){var g=f.shift();b(g,null,a).done(function(a,b){d.resolve(a,b,g);c++;e(a,f)}).fail(function(a,c){d.reject(a,c)})}}var g=f.replace(/^\s+|;\s*$/,"").split(";"),n=[],c=0,x=a.Deferred();n.push(x);c++;a.each(g,function(){n.push(a.Deferred())});d?e(d,g):o("read-write").ready(function(a,c){e(c,g)}).done(function(a,c){x.resolve(a,c)}).fail(function(a,c){x.reject(a,
c)});var h=[];a.each(n,function(a,c){h.push(c.promise())});return a.when.apply(this,h)}function p(){return d(r)}function h(f){return a.Deferred(function(a){b("SELECT name FROM sqlite_master WHERE type='table'",null,f).done(function(b,f){for(var n=[],c=0;c<f.rows.length;c++)n.push(f.rows.item(c).name);a.resolve(b,n)}).fail(function(b,f){a.reject(b,f)})}).promise()}function g(f,d,e){return a.Deferred(function(a){b(e?"INSERT INTO client_info ( session, token, token_sent, reset, port, last_sync_success, client_id ) VALUES (?, ?, ?, ?, ?, ?, ?)":
"UPDATE client_info SET session = ?, token = ?, token_sent = ?, reset = ?, port = ?, last_sync_success = ? WHERE client_id = ?",[f.session,f.token,f.token_sent,f.reset,f.port,f.last_sync_success,f.id],d).done(function(b){a.resolve(b,f)}).fail(function(b,c){a.reject(b,c)})}).promise()}function k(f,d,e){return a.Deferred(function(a){b(e?"INSERT INTO sources ( name, token, sync_priority, partition, sync_type, metadata, last_updated, last_inserted_size, last_deleted_size, last_sync_duration, last_sync_success, backend_refresh_time, source_attribs, schema, schema_version, associations, blob_attribs, source_id ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)":
"UPDATE sources SET name = ?, token = ?, sync_priority = ?, partition = ?, sync_type = ?, metadata = ?, last_updated = ?, last_inserted_size = ?, last_deleted_size = ?, last_sync_duration = ?, last_sync_success = ?, backend_refresh_time = ?, source_attribs = ?, schema = ?, schema_version = ?, associations = ?, blob_attribs = ? WHERE source_id = ?",[f.name,f.token,f.sync_priority,f.partition,f.sync_type,f.metadata,f.last_updated,f.last_inserted_size,f.last_deleted_size,f.last_sync_duration,f.last_sync_success,
f.backend_refresh_time,f.source_attribs,f.schema,f.schema_version,f.associations,f.blob_attribs,f.id],d).done(function(b){a.resolve(b,f)}).fail(function(b,c){a.reject(b,c)})}).promise()}var l=RhoConnect.rho,r='DROP TABLE IF EXISTS client_info;CREATE TABLE client_info ( "client_id" VARCHAR(255) default NULL, "session" VARCHAR(255) default NULL, "token" VARCHAR(255) default NULL, "token_sent" BIGINT default 0, "reset" BIGINT default 0, "port" VARCHAR(10) default NULL, "last_sync_success" VARCHAR(100) default NULL);DROP TABLE IF EXISTS object_values;CREATE TABLE object_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL);DROP TABLE IF EXISTS changed_values;CREATE TABLE changed_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL, "attrib_type" varchar(255) default NULL, "update_type" varchar(255) default NULL, "sent" BIGINT default 0);DROP TABLE IF EXISTS sources;CREATE TABLE sources ( "source_id" BIGINT PRIMARY KEY, "name" VARCHAR(255) default NULL, "token" BIGINT default NULL, "sync_priority" BIGINT, "partition" VARCHAR(255), "sync_type" VARCHAR(255), "metadata" varchar default NULL, "last_updated" BIGINT default 0, "last_inserted_size" BIGINT default 0, "last_deleted_size" BIGINT default 0, "last_sync_duration" BIGINT default 0, "last_sync_success" BIGINT default 0, "backend_refresh_time" BIGINT default 0, "source_attribs" varchar default NULL, "schema" varchar default NULL, "schema_version" varchar default NULL, "associations" varchar default NULL, "blob_attribs" varchar default NULL);DROP INDEX IF EXISTS by_src_id;CREATE INDEX by_src_id on object_values ("source_id");DROP INDEX IF EXISTS by_src_object;CREATE UNIQUE INDEX by_src_object ON object_values ("object", "attrib", "source_id");DROP INDEX IF EXISTS by_src_value;CREATE INDEX by_src_value ON object_values ("attrib", "source_id", "value");',
e={},m=new function(){this.blobAttrs={};this.srcNames={};this.initAttrManager=function(){return this.loadAttrs()};this.isBlobAttr=function(a,b){var d=this.blobAttrs[a];return d?b in d:!1};this.loadAttrs=function(){var b=this;return a.Deferred(function(d){b.blobAttrs={};var e="SELECT source_id,";e+="blob_attribs,name from sources";l.storage.executeSql(e).done(function(e,n){for(var c=0;c<n.rows.length;c++){var g=n.rows.item(0).source_id,h=n.rows.item(0).blob_attribs;if(!h)return;var l=new {},m="";a.each(h.split(","),
function(a,c){c&&(m?(l[m]=+c,m=""):m=c)});b.blobAttrs[g]=l;b.srcNames!=null&&(b.srcNames[n.rows.item(c).name.toUpperCase()]=g)}d.resolve()}).fail(function(a,b){d.reject(a,b)})}).promise()}};a.extend(l,{storage:{attrManager:m,listClientsId:function(d){return a.Deferred(function(a){b("SELECT client_id FROM client_info",null,d).done(function(b,d){for(var f=[],c=0;c<d.rows.length;c++)f.push(d.rows.item(c).client_id);a.resolve(b,f)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadClient:function(d,
e){return a.Deferred(function(a){b("SELECT * FROM client_info WHERE client_id = ?",[d],e).done(function(b,e){if(0==e.rows.length)a.reject(d,"Not found");else{var c=new l.engine.Client(d);c.session=e.rows.item(0).session;c.token=e.rows.item(0).token;c.token_sent=e.rows.item(0).token_sent;c.reset=e.rows.item(0).reset;c.port=e.rows.item(0).port;c.last_sync_success=e.rows.item(0).last_sync_success;a.resolve(b,c)}}).fail(function(b,d){a.reject(b,d)})}).promise()},loadAllClients:function(d){return a.Deferred(function(a){b("SELECT * FROM client_info",
null,d).done(function(b,d){for(var f=[],c=0;c<d.rows.length;c++){var e=new l.engine.Client(d.rows.item(c).client_id);e.session=d.rows.item(c).session;e.token=d.rows.item(c).token;e.token_sent=d.rows.item(c).token_sent;e.reset=d.rows.item(c).reset;e.port=d.rows.item(c).port;e.last_sync_success=d.rows.item(c).last_sync_success;f.push(e)}a.resolve(b,f)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeClient:g,insertClient:function(a,b){return g(a,b,!0)},deleteClient:function(d,e){var g="object"==
typeof d?d.id:d;return a.Deferred(function(a){b("DELETE FROM client_info WHERE client_id = ?",[g],e).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},listSourcesId:function(d){return a.Deferred(function(a){b("SELECT source_id FROM sources",null,d).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++)e.push(d.rows.item(c).source_id);a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadSource:function(d,e){return a.Deferred(function(a){b("SELECT * FROM sources WHERE source_id = ?",
[d],e).done(function(b,e){if(0==e.rows.length)a.reject(d,"Not found");else{var c=new l.engine.Source(e.rows.item(0).source_id,e.rows.item(0).name,e.rows.item(0).sync_type,l.storage,l.engine);c.token=e.rows.item(0).token;c.sync_priority=e.rows.item(0).sync_priority;c.partition=e.rows.item(0).partition;c.sync_type=e.rows.item(0).sync_type;c.metadata=e.rows.item(0).metadata;c.last_updated=e.rows.item(0).last_updated;c.last_inserted_size=e.rows.item(0).last_inserted_size;c.last_deleted_size=e.rows.item(0).last_deleted_size;
c.last_sync_duration=e.rows.item(0).last_sync_duration;c.last_sync_success=e.rows.item(0).last_sync_success;c.backend_refresh_time=e.rows.item(0).backend_refresh_time;c.source_attribs=e.rows.item(0).source_attribs;c.schema=e.rows.item(0).schema;c.schema_version=e.rows.item(0).schema_version;c.associations=e.rows.item(0).associations;c.blob_attribs=e.rows.item(0).blob_attribs;c.parseAssociations();a.resolve(b,c)}}).fail(function(b,d){a.reject(b,d)})}).promise()},loadAllSources:function(d){return a.Deferred(function(a){b("SELECT * FROM sources ORDER BY sync_priority",
null,d).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++){var f=new l.engine.Source(d.rows.item(c).source_id,d.rows.item(c).name,d.rows.item(c).sync_type,l.storage,l.engine);f.token=d.rows.item(c).token;f.sync_priority=d.rows.item(c).sync_priority;f.partition=d.rows.item(c).partition;f.sync_type=d.rows.item(c).sync_type;f.metadata=d.rows.item(c).metadata;f.last_updated=d.rows.item(c).last_updated;f.last_inserted_size=d.rows.item(c).last_inserted_size;f.last_deleted_size=d.rows.item(c).last_deleted_size;
f.last_sync_duration=d.rows.item(c).last_sync_duration;f.last_sync_success=d.rows.item(c).last_sync_success;f.backend_refresh_time=d.rows.item(c).backend_refresh_time;f.source_attribs=d.rows.item(c).source_attribs;f.schema=d.rows.item(c).schema;f.schema_version=d.rows.item(c).schema_version;f.associations=d.rows.item(c).associations;f.blob_attribs=d.rows.item(c).blob_attribs;f.parseAssociations();e.push(f)}a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeSource:k,insertSource:function(a,
b){return k(a,b,!0)},deleteSource:function(d,e){var g="object"==typeof d?d.id:d;return a.Deferred(function(a){b("DELETE FROM sources WHERE source_id = ?",[g],e).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},init:function(b){return a.Deferred(function(a){h().done(function(d,e){(5!=e.length||b)&&p().done(function(){a.resolve(null,"db schema initialized")}).fail(function(b,c){a.reject(b,"db schema initialization error: "+c)});a.resolve(null,"db schema is ok")}).fail(function(b,
d){a.reject(b,"db tables read error: "+d)})}).promise()},open:j,tx:o,roTx:function(a){return o(!1,a)},rwTx:function(a){return o("read-write",a)},executeSql:b,executeBatchSql:d,initSchema:p,getAllTableNames:h}})})(jQuery);
(function(a){function j(){return N=N||new i.notify.SyncNotify(i.engine)}function o(){return O}function b(){return G}function d(){return a.Deferred(function(a){A="";i.storage.executeSql("SELECT session FROM client_info").done(function(c,b){for(var d=0;d<b.rows.length;d++){var e=b.rows.item(d).session;if(e){A=e;break}}a.resolve()}).fail(q(a))}).promise()}function p(){return a.Deferred(function(a){i.storage.executeSql("UPDATE client_info SET session = NULL").done(function(){A="";i.protocol.logout();
a.resolve()}).fail(q(a))}).promise()}function h(c,b,d,f){return a.Deferred(function(a){H=!1;i.protocol.login(c,b).done(function(){A=c;i.config.database.name=i.config.appName+i.config.database.nameSuffix+c;A||J.error("Server responds with empty session cookie.");i.storage.init(f).done(function(){if(A)H?a.reject(i.ERRORS.ERR_CANCELBYUSER,"Stopped by user"):g(c).done(function(){i.config.rho_sync_user=name;j().callLoginCallback(d,i.ERRORS.ERR_NONE,"");a.resolve()}).fail(t(a));else{J.error("DB doesn't contains this session.");
var b=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;j().callLoginCallback(d,b,"");a.reject(b,"")}}).fail(t(a))}).fail(function(c,b,f){c=i.protocol.getErrCodeFromXHR(f);if(e(b))c=i.ERRORS.ERR_NOSERVERRESPONSE;c!=i.ERRORS.ERR_NONE&&j().callLoginCallback(d,c,f.responseText);a.reject(c,b)})}).promise()}function g(c){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b){if(0<b.length)i.storage.executeSql("UPDATE client_info SET session=?",[c]).done(function(){a.resolve(b[0])}).fail(q(a));else{var d=
new K(null);d.session=c;i.storage.insertClient(d).done(function(c,b){a.resolve(b)}).fail(q(a))}}).fail(q(a))}).promise()}function k(c){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b,d){if(0<d.length)i.storage.executeSql("UPDATE client_info SET client_id=?",[c]).done(function(){a.resolve(c)}).fail(q(a));else{var e=new K(null);e.id=c;i.storage.insertClient(e).done(function(){a.resolve(c)}).fail(q(a))}}).fail(q(a))}).promise()}function l(){return a.Deferred(function(a){i.protocol.clientCreate().done(function(c,
b){b&&b.client&&b.client.client_id?k(b.client.client_id).done(function(c){a.resolve(c)}).fail(t(a)):a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,b)}).fail(function(c,b){var d=e(b)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;a.reject(d,b)})}).promise()}function r(c){return a.Deferred(function(a){i.protocol.clientReset(c).done(function(c,b){b&&b.sources?a.resolve():a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,b)}).fail(function(c,b){var d=e(b)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;
a.reject(d,b)})}).promise()}function e(a){return a&&a.match(/time(d)?\s+out/i)}function m(){return a.Deferred(function(a){f(u.syncAllSources,null).done(function(){I()?x().done(function(){if(y!=u.exit)y=u.none;j().cleanCreateObjectErrors();a.resolve()}).fail(function(c,b){if(y!=u.exit)y=u.none;i.notify.byEvent(i.EVENTS.ERROR,"Sync failed",b);a.reject(c,b)}):(j().cleanCreateObjectErrors(),a.resolve())}).fail(function(b,c){a.reject(b,c)})}).promise()}function f(b,c){return a.Deferred(function(a){y=b;
O=b==u.search;H=!1;B=i.ERRORS.ERR_NONE;F="";G=!1;n().done(function(){C().done(function(b){function d(){var a=null;c&&(a=s("id",c));a?(a.errCode=B,a.error=F,j().fireSyncNotification(a,!0,a.errCode,"")):j().fireAllSyncNotifications(!0,B,F,"")}A=b;L()?v().done(function(b){P=b;B==i.ERRORS.ERR_NONE?(j().cleanLastSyncObjectCount(),a.resolve()):(d(),E(),a.reject(B,F))}).fail(t(a)):(B=i.ERRORS.ERR_CLIENTISNOTLOGGEDIN,d(),E(),a.reject(B,F))}).fail(t(a))}).fail(t(a))}).promise()}function s(a,b){for(var c=0;c<
w.length;c++)if(w[c][a]==b)return w[c];return null}function C(){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b,c){for(var d=null,e=0;e<c.length;e++)if(c[e].session){d=c[e].session;break}a.resolve(d)}).fail(q(a))}).promise()}function v(){return a.Deferred(function(a){var c="",b=!1;i.storage.loadAllClients().done(function(d,e){var f=null;if(0<e.length)f=e[0],c=f.id,b=f.reset;c?b?r(c).done(function(c){f.reset=0;i.storage.storeClient(f).done(function(){a.resolve(c)}).fail(function(c,
b){E();q(a)(c,b)})}).fail(function(c,b){E();a.reject(c,b)}):a.resolve(c):l().done(function(c){a.resolve(c)}).fail(t(a))}).fail(q(a))}).promise()}function n(){return a.Deferred(function(b){D={};i.storage.loadAllSources().done(function(d,e){a.each(e,function(a,c){if(c.sync_type!="none")c.storage=i.storage,c.engine=i.engine,D[c.name]=c});c();b.resolve()}).fail(q(b))}).promise()}function c(){function c(a,b,d){if(b>=a.length)return a.concat(d);b<0&&(b=0);return a.slice(0,b).concat(d,a.slice(b))}function b(a,
c){for(var d=0;d<a.length;d++)if(c==a[d].name)return d;return-1}var d={},e=[];a.each(D,function(a,c){e.push(c)});e.sort(function(a,c){if(a.sync_priority<c.sync_priority)return-1;if(a.sync_priority>c.sync_priority)return 1;return 0});for(var f=e.length-1;f>0;){var g=e[f];if(g.getAssociations().length==0||g.name in d)f--;else for(var i=f,h=0;h<g.getAssociations().length;h++){var m=g.getAssociations()[h],m=b(e,m.m_strSrcName);m>=0&&m<i&&(e.splice(i,1),c(e,m,g),i=m)}d[g.name]=!0}D={};a.each(e,function(a,
c){D[c.name]=c});w=e}function x(){return a.Deferred(function(c){var b=!1,d={};a.each(w,function(a,c){d[c.name]=c});var e=i.deferredMapOn(a.extend({},d,{rhoStartSyncSource:"noMatterValue_itUseJustKeys"})),f=[],g=Q(),h=0<=g?w[g]:null;0<=g?M(g).done(function(){e.resolve("rhoStartSyncSource",["ok"])}).fail(function(a,c){b=!0;f.push({source:h.name,errCode:a,error:c});e.resolve("rhoStartSyncSource",["error",a,c])}):e.resolve("rhoStartSyncSource",["ok"]);a.each(w,function(a,c){M(a).done(function(){e.resolve(c.name,
["ok"])}).fail(function(a,d){b=!0;f.push({source:c.name,errCode:a,error:d});e.resolve(c.name,["error",a,d])})});e.when().done(function(){!b&&!G?(j().fireSyncNotification(null,!0,i.ERRORS.ERR_NONE,"sync_completed"),c.resolve(i.ERRORS.NONE,"Sync completed")):c.reject('Error for source"'+f[0].source+'": '+(f[0].error||f[0].errCode))}).fail(function(){J.error("Implementation error in SyncEngine.syncAllSources: some source has been rejected!");c.reject(f)})}).promise()}function Q(){for(var a=0;a<w.length;a++)if(!w[a].isEmptyToken())return a;
return-1}function M(c){return a.Deferred(function(a){var b=w[c];if(b.sync_type=="bulk_sync_only")a.resolve(null);else if(L()&&y!=u.stop){b.sync().done(function(){a.resolve(b)}).fail(function(c,d){if(b.errCode==i.ERRORS.ERR_NONE)b.errCode=i.ERRORS.ERR_RUNTIME;y=u.stop;a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped: "+d)}).then(d,d);var d=function(){j().onSyncSourceEnd(c,w)}}else a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped")}).promise()}function R(){return y}function S(a){y=a}function I(){var a=
y;return a!=u.exit&&a!=u.stop}function E(){if(I())y=u.stop}function T(c){var b=0;a.each(c,function(a,c){b=c.id>b?c.id:b});b<i.engine.maxConfigSrcId?b=i.engine.maxConfigSrcId+2:b+=1;return b}function U(){return V}function W(){return!1}function L(){return A?!0:!1}function X(c,b,d,f,g){function h(a,c){this.m_strSrcName=a;this.m_strAttrib=c}function m(a,c){this.m_strAttrib=a;this.m_strValue=c;this.m_strBlobSuffix="";if("string"==typeof this.m_strAttrib&&this.m_strAttrib.match(/\-rhoblob$/))this.m_strBlobSuffix=
"-rhoblob",this.m_strAttrib=this.m_strAttrib.substring(0,this.m_strAttrib.length-this.m_strBlobSuffix.length)}function l(){return a.Deferred(function(c){function b(d,e){for(var f=[],g=[],h=[],z=0;z<e.rows.length;z++)f.push(e.rows.item(z).object),h.push(e.rows.item(z).source_id),g.push(e.rows.item(z).update_type);var m=i.deferredMapOn(f);a.each(f,function(a,b){i.storage.executeSql("SELECT name, schema FROM sources WHERE source_id=?",[h[a]],d).done(function(d,e){var f=!1,z="object_values";if(e.rows.length>
0)(f=e.rows.item(0).schema)&&(z=e.rows.item(0).name);if(f)m.resolve(a,[]);else{i.storage.executeSql("SELECT attrib, value FROM "+z+" where object=? and source_id=?",[b,h[a]],d).done(function(a,c){k(a,c)}).fail(q(c));var k=function(d,e){for(var f=0;f<e.rows.length;f++){var z=e.rows.item(f).attrib,k=e.rows.item(f).value,l=i.storage.attrManager.isBlobAttr(h[a],z)?"blob.file":"";i.storage.executeSql("INSERT INTO changed_values (source_id,object,attrib,value,update_type,attrib_type,sent) VALUES(?,?,?,?,?,?,?)",
[h[a],b,z,k,g[a],l,0],d).done(function(){}).fail(q(c))}m.resolve(a,[])}}}).fail(function(c,b){m.reject(a,[c,b])})});m.when().done(function(){i.storage.executeSql("DELETE FROM changed_values WHERE attrib=?",["object"],d)}).fail(q(c))}i.storage.rwTx().ready(function(a,c){i.storage.executeSql("SELECT object, source_id, update_type FROM changed_values where attrib = 'object' and sent=0",[],c).done(function(a,c){0!=c.rows.length&&b(a,c)})}).done(function(){c.resolve()}).fail(function(a,b){q(c)(a,b)})}).promise()}
var k=new i.Logger("SyncSource");this.storage=f;this.engine=g;this.id=c;this.name=b;this.partition=this.sync_priority=this.token=null;this.sync_type=d;this.metadata=null;this.backend_refresh_time=this.last_sync_success=this.last_sync_duration=this.last_deleted_size=this.last_inserted_size=this.last_updated=0;this.blob_attribs=this.associations=this.schema_version=this.schema=this.source_attribs=null;this.arAssociations=[];this.getAssociations=function(){return this.arAssociations};this.isTokenFromDb=
!0;this.errCode=i.ERRORS.ERR_NONE;this.serverError=this.error="";this.deletedCount=this.insertedCount=this.serverObjectsCount=this.curPageCount=this.totalCount=0;this.getAtLeastOnePage=!1;this.refreshTime=0;this.multipartItems=[];this.blobAttrs=[];this.schemaSource=!1;this.progressStep=-1;this.isEmptyToken=function(){return this.token==0};this.setToken=function(a){this.token=a;this.isTokenFromDb=!1};this.processToken=function(c){var b=this;return a.Deferred(function(a){c>1&&b.token==c?(b.setToken(c),
a.resolve()):(b.setToken(c),i.storage.executeSql("UPDATE sources SET token=? where source_id=?",[+b.token,b.id]).done(function(){a.resolve()}).fail(q(a)))}).promise()};this.parseAssociations=function(c){var b=this;if(c){var d="";a.each(c.split(","),function(a,c){d?(b.arAssociations.push(new h(d,c)),d=""):d=c})}};this.syncServerChanges=function(){var c=this;return a.Deferred(function(a){function b(){c.curPageCount=0;var f=i.protocol.getServerQueryUrl(""),g=c.engine.getClientId(),h=c.engine.getSyncPageSize(),
m=!c.isTokenFromDb&&c.token>1?c.token:null;k.info("Pull changes from server. Url: "+(f+d(c.name,g,h,m)));i.protocol.serverQuery(c.name,g,h,m).done(function(d,f){c.processServerResponse_ver3(f).done(function(){function d(){c.token&&c.engine.isContinueSync()?b():e||(e=!0,c.engine.isSchemaChanged()&&c.engine.stopSync(),a.resolve())}c.engine.getSourceOptions().getBoolProperty(c.id,"pass_through")?c.processToken(0).done(function(){d()}).fail(function(c,b){t(a)(c,b)}):d()}).fail(function(c,b){t(a)(c,b)})}).fail(function(b,
d,e){c.engine.stopSync();c.errCode=i.protocol.getErrCodeFromXHR(e);c.error=d;a.reject(B,d)})}function d(a,c,b,e){c="?client_id="+c+"&p_size="+b+"&version=3";c+=a?"&source_name="+a:"";return c+(e?"&token="+e:"")}k.info("Sync server changes source ID :"+c.id);b();var e=!1}).promise()};this.processServerResponse_ver3=function(c){var b=this;return a.Deferred(function(a){function d(){function g(){function d(){b.curPageCount>0&&b.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"");a.resolve()}
k.info("Got "+b.curPageCount+"(Processed: "+b.serverObjectsCount+") records of "+b.totalCount+" from server. Source: "+b.name+". Version: "+f.version);if(b.engine.isContinueSync()){f=c[e];e++;var h=f;void 0!=h["schema-changed"]?(b.engine.setSchemaChanged(!0),d()):b.processServerErrors(h)?d():i.storage.rwTx().ready(function(c,e){function f(){function c(){void 0!=h.links&&b.engine.isContinueSync()&&b.processSyncCommand("links",h.links,!0,e);void 0!=h["delete"]&&b.engine.isContinueSync()&&b.processSyncCommand("delete",
h["delete"],!0,e);void 0!=h.insert&&b.engine.isContinueSync()&&b.processSyncCommand("insert",h.insert,!0,e);b.getNotify().fireObjectsNotification();d()}void 0!=h.metadata&&b.engine.isContinueSync()?i.storage.executeSql("UPDATE sources SET metadata=? WHERE source_id=?",[h.metadata,b.id],e).done(function(){c()}).fail(q(a)):c()}b.engine.getSourceOptions().getBoolProperty(b.id,"pass_through")?b.schemaSource||i.storage.executeSql("DELETE FROM object_values WHERE source_id=?",[b.id],e).done(function(){f()}).fail(q(a)):
f()}).done(function(){a.resolve()}).fail(function(c,b){q(a)(c,b)})}else d()}f=c[e];void 0!=f.source&&e++;f=c[e];if(void 0!=f.count)e++,b.curPageCount=+f.count;f=c[e];if(void 0!=f.refresh_time)e++,b.refreshTime=+f.refresh_time;f=c[e];void 0!=f.progress_count&&e++;f=c[e];if(void 0!=f.total_count)e++,b.totalCount=+f.total_count;b.token==0?i.storage.executeSql("DELETE FROM changed_values where source_id=? and sent>=3",[b.id]).done(function(){g()}).fail(q(a)):g()}var e=0,f=null,f=c[e];if(void 0!=f.version&&
(e++,f.version!=i.protocol.getVersion())){k.error("Sync server send data with incompatible version. Client version: "+i.protocol.getVersion()+"; Server response version: "+f.version+". Source name: "+b.name);b.engine.stopSync();b.errrCode=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;a.reject(b.errCode,"Sync server send data with incompatible version.");return}f=c[e];void 0!=f.token?(e++,b.processToken(+f.token).done(function(){d()}).fail(function(c,d){a.reject(b.errCode,d)})):d()}).promise()};this.processSyncCommand=
function(c,b,d,e){var f=this;return a.Deferred(function(g){var h=i.deferredMapOn(b);a.each(b,function(b,g){function m(){h.resolve(b,[e]);if(f.sync_type!="none"&&d){var a=f.getNotify().incLastSyncObjectCount(f.id);f.progressStep>0&&a%f.progressStep==0&&f.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"")}}f.engine.isContinueSync()&&(f.schemaSource||a.each(g,function(a,d){f.engine.isContinueSync()&&f.processServerCmd_Ver3(c,b,a,d,e).done(function(){m()}).fail(function(a,c){k.error("Sync of server changes failed for "+
f.name+"; object: "+b,c);h.reject(b,[a,c])})}))});h.when().done(function(){g.resolve(e)}).fail(t(g))}).promise()};this.processServerCmd_Ver3=function(c,b,d,e,f){var g=this;return a.Deferred(function(a){var h=new m(d,e);if(c=="insert"){i.storage.executeSql("SELECT source_id FROM object_values WHERE object=? and attrib=? and source_id=? LIMIT 1 OFFSET 0",[b,h.m_strAttrib,g.id],f).done(function(c,d){0==d.rows.length?i.storage.executeSql("INSERT INTO object_values (attrib, source_id, object, value) VALUES(?,?,?,?)",
[h.m_strAttrib,g.id,b,h.m_strValue],c).done(function(){k()}).fail(q(a)):i.storage.executeSql("UPDATE object_values SET value=? WHERE object=? and attrib=? and source_id=?",[h.m_strValue,b,h.m_strAttrib,g.id],c).done(function(c){g.sync_type!="none"?i.storage.executeSql("UPDATE changed_values SET sent=4 where object=? and attrib=? and source_id=? and sent>1",[b,h.m_strAttrib,g.id],c).done(function(){k()}).fail(q(a)):k()}).fail(q(a))}).fail(q(a));var k=function(){if(g.sync_type!="none")g.getNotify().onObjectChanged(g.id,
b,i.notify.ACTIONS.update);g.insertedCount++;a.resolve(f)}}else c=="delete"?i.storage.executeSql("DELETE FROM object_values where object=? and attrib=? and source_id=?",[b,h.m_strAttrib,g.id],f).done(function(c){g.sync_type!="none"?(g.getNotify().onObjectChanged(g.id,b,i.notify.ACTIONS["delete"]),i.storage.executeSql("UPDATE changed_values SET sent=3 where object=? and attrib=? and source_id=?",[b,h.m_strAttrib,g.id],c).done(function(){g.deletedCount++;a.resolve(c)}).fail(q(a))):(g.deletedCount++,
a.resolve(c))}).fail(q(a)):c=="links"&&g.processAssociations(b,h.m_strValue,f).done(function(c){i.storage.executeSql("UPDATE object_values SET object=? where object=? and source_id=?",[h.m_strValue,b,g.id],c).done(function(){i.storage.executeSql("UPDATE changed_values SET object=?,sent=3 where object=? and source_id=?",[h.m_strValue,b,g.id],c).done(function(){g.getNotify().onObjectChanged(g.id,b,i.notify.ACTIONS.create);a.resolve(c)}).fail(q(a))}).fail(q(a))}).fail(t(a))}).promise()};this.processAssociations=
function(c,b,d){var e=this;return a.Deferred(function(a){if(e.associations.length==0)a.resolve();else{for(var f=i.deferredMapOn(e.associations),h=0;h<e.associations.length;h++){var m=g.findSourceBy("name",e.associations[h].m_strSrcName);m&&m.updateAssociation(c,b,e.associations[h].m_strAttrib,d).done(function(){f.resolve(h,[])}).fail(function(a,c){f.reject(h,[a,c])})}f.when().done(function(){a.resolve(d)}).fail(t(a))}}).promise()};this.updateAssociation=function(c,b,d,e){var f=this;return a.Deferred(function(a){function g(){i.storage.executeSql("UPDATE changed_values SET value=? where attrib=? and source_id=? and value=?",
[b,d,f.id,c],e).done(function(){a.resolve(e)}).fail(q(a))}f.schemaSource?g():i.storage.executeSql("UPDATE object_values SET value=? where attrib=? and source_id=? and value=?",[b,d,f.id,c],e).done(function(){g()}).fail(q(a))}).promise()};this.processServerErrors=function(c){function b(d){f=!0;e.ErrCode=i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(c[d],function(a,c){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(a)+"][message]="+encodeURI(c.message)})}function d(b){f=!0;e.ErrCode=
i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(c[b],function(c,d){c.match(/-error$/i)?(c=c.substring(0,c.length-6),e.serverError+=e.serverError?"&":"",e.serverError+="server_errors["+encodeURI(b)+"]["+encodeURI(c)+"][message]="+encodeURI(d.message)):a.each(d,function(a,d){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(b)+"]["+encodeURI(c)+"][attributes]["+encodeURI(a)+"]="+encodeURI(d)})})}var e=this,f=!1;a.each(c,function(a){a.match(/^(source|search)-error$/i)?b(a):a.match(/-error$/i)&&
d(a)});return f};this.syncClientChanges=function(){var c=this;return a.Deferred(function(a){function b(){c.isPendingClientChanges().done(function(b){d&&b?(k.info("Server does not sent created items. Stop sync."),c.engine.setState(u.stop),a.resolve(d)):i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? LIMIT 1 OFFSET 0",[c.id]).done(function(b,e){var f=!1;(f=e.rows&&e.rows.length&&0<e.rows.length)?c.doSyncClientChanges().done(function(){d=!1;a.resolve(d)}).fail(t(a)):a.resolve(d)}).fail(q(a))}).fail(q(a))}
var d=!1;c.isPendingClientChanges().done(function(e){e?(k.info("Client has unconfirmed created items. Call server to update them."),c.syncServerChanges().done(function(){d=!0;b()}).fail(t(a))):b()}).fail(q(a))}).promise()};this.isPendingClientChanges=function(){var c=this;return a.Deferred(function(a){i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? and update_type='create' and sent>1  LIMIT 1 OFFSET 0",[c.id]).done(function(c,b){a.resolve(b.rows&&b.rows.length&&0<b.rows.length)}).fail(function(c,
b){a.reject(c,b)})}).promise()};this.doSyncClientChanges=function(){var c=this;return a.Deferred(function(b){function d(){function f(){var d=i.deferredMapOn(g);a.each(g,function(a,b){c.engine.isContinueSync()&&b?a=="create"?c.storage.executeSql("UPDATE changed_values SET sent=2 WHERE source_id=? and update_type=? and sent=1",[c.id,a]).done(function(){d.resolve(a,[])}).fail(function(c,b){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+b])}):c.storage.executeSql("DELETE FROM changed_values WHERE source_id=? and update_type=? and sent=1",
[c.id,a]).done(function(){d.resolve(a,[])}).fail(function(c,b){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+b])}):d.resolve(a,[])});d.when().done(function(){c.multipartItems=[];c.blobAttrs=[];b.resolve()}).fail(t(b))}h?(k.info("Push client changes to server. Source: "+c.name),k.trace("Push body: "+a.toJSON(m)),c.multipartItems.length>0?f():i.protocol.postData(m).done(function(){f()}).fail(function(a,d,f){c.engine.setState(i.states.stop);c.errCode=i.protocol.getErrCodeFromXHR(f);c.errCode=
e(d)?i.ERRORS.ERR_NOSERVERRESPONSE:c.errCode;c.error=d;b.reject(c.errCode,c.error)})):f()}var f=["create","update","delete"],g={};c.multipartItems=[];c.blobAttrs=[];var h=!1,m={source_name:c.name,client_id:c.engine.getClientId()},l=i.deferredMapOn(f);a.each(f,function(a,b){c.engine.isContinueSync()?(h=g[b]=!0,c.makePushBody_Ver3(b,!0).done(function(c){m[b]=c;l.resolve(a,[])}).fail(function(c,b){l.reject(a,[c,b])})):l.resolve(a,[])});l.when().done(function(){d()}).fail(t(b))}).promise()};this.makePushBody_Ver3=
function(c,b){var d=this;return a.Deferred(function(a){function e(){function g(e,h){if(h.rows&&h.rows.length&&0==h.rows.length)a.resolve(f);else{for(var m=0;m<h.rows.length;m++){var k=h.rows.item(m).attrib,l=h.rows.item(m).object,n=h.rows.item(m).value;h.rows.item(m);f[l]||(f[l]={});f[l][k]=n}b&&i.storage.executeSql("UPDATE changed_values SET sent=1 WHERE source_id=? and update_type=? and sent=0",[d.id,c]).done(function(){a.resolve(f)}).fail(q(a))}}i.storage.executeSql("SELECT attrib, object, value, attrib_type FROM changed_values where source_id=? and update_type =? and sent<=1 ORDER BY object",
[d.id,c]).done(function(a,c){g(a,c)}).fail(q(a))}var f={};b?l().done(function(){e()}).fail(q(a)):e()}).promise()};this.sync=function(){var c=this;return a.Deferred(function(a){function b(e,f){c.engine.stopSync();d();a.reject(e,f)}function d(){var a=Date.now();i.storage.executeSql("UPDATE sources set last_updated=?,last_inserted_size=?,last_deleted_size=?, last_sync_duration=?,last_sync_success=?, backend_refresh_time=? WHERE source_id=?",[a/1E3,c.getInsertedCount(),c.getDeletedCount(),a-e,c.getAtLeastOnePage?
1:0,c.refreshTime,c.id])}c.getNotify().reportSyncStatus("syncronizing"+c.name+"...",c.errCode,c.error);var e=Date.now();if(c.isTokenFromDb&&c.token>1)c.syncServerChanges().done(function(){d();a.resolve()}).fail(b);else{c.isEmptyToken()?c.processToken(1).done(function(){f()}).fail(b):f();var f=function(){c.syncClientChanges().done(function(e){e?(d(),a.resolve()):c.syncServerChanges().done(function(){d();a.resolve()}).fail(b)}).fail(b)}}}).promise()};this.getNotify=function(){return this.engine.getNotify()};
this.getInsertedCount=function(){return this.insertedCount};this.getDeletedCount=function(){return this.deletedCount}}function q(a){return function(c,b){a.reject(i.ERRORS.ERR_RUNTIME,"db access error: "+b)}}function t(a){return function(c,b){a.reject(c,b)}}function K(a){this.id=a;this.token=this.session=null;this.reset=this.token_sent=0;this.last_sync_success=this.port=null}var i=RhoConnect.rho,u={none:0,syncAllSources:1,syncSource:2,search:3,stop:4,exit:5},D={},w=[],V=new function(){var a={};this.setProperty=
function(c,b,d){var e=a[c];e||(e={},a[c]=e);e[b]=d||""};this.getProperty=function(c,b){var d=a[c];if(d)return d[b]||"";return""};this.getBoolProperty=function(a,c){var b=this.getProperty(a,c);return b=="1"||b=="true"}},N=null,y=u.none,O=!1,B=i.ERRORS.ERR_NONE,F="",G=!1,A=null,P=null,J=new i.Logger("SyncEngine"),H=!1;a.extend(i,{engine:function(){return{Client:K,Source:X,STATES:u,getSession:function(){return A},restoreSession:d,getSources:function(){return D},getSourcesArray:function(){return w},maxConfigSrcId:1,
login:h,logout:p,getState:R,setState:S,isSearch:o,doSyncAllSources:m,stopSync:E,getNotify:j,getSyncPageSize:function(){return 2E3},getClientId:function(){return P},getStartSourceId:T,findSourceBy:s,getSourceOptions:U,isNoThreadedMode:W,isSessionExist:L,isContinueSync:I,setSchemaChanged:function(a){G=a},isSchemaChanged:b,isStoppedByUser:function(){return H}}}()})})(jQuery);
(function(a){function j(a,b){this.params=a||"";this.removeAfterFire=b||!1;this.toString=function(){return"SyncNotification({removeAfterFire: "+this.removeAfterFire+"})"}}var o=RhoConnect.rho,b={none:0,"delete":1,update:2,create:3};a.extend(o,{notify:{ACTIONS:b,SyncNotify:function(d){function p(c){if(!m[c])return"";var b="";a.each(l,function(a,c){b+="&create_error[][object]="+a;b+="&create_error[][error_message]="+c});return b}function h(a){var b=null;d.isSearch()?b=f:(a!=null&&(b=s[a.id]),b==null&&
(b=C));if(b==null&&!d.isNoThreadedMode())return null;return b!=null?b:v}function g(a){if(d.isNoThreadedMode())return!1;return a&&"function"==typeof a.params?a.params():!0}var k=new o.Logger("SyncNotify"),l={},r="",e="",m={},f=null,s={},C=null,v=j(),n={};this.cleanCreateObjectErrors=function(){m={}};this.fireObjectsNotification=function(){var c="";a.each(l,function(d,e){a.each(e,function(a,f){if(f!=b.none)c&&(c+="&rho_callback=1&"),f==b["delete"]?(c+="deleted[][object]="+a,c+="&deleted[][source_id]="+
d):f==b.update?(c+="updated[][object]="+a,c+="&updated[][source_id]="+d):f==b.create&&(c+="created[][object]="+a,c+="&created[][source_id]="+d),e[a]=b.none})});c&&g(new j("",!1),c)};this.onObjectChanged=function(a,f,g){if(r){var h=d.getSources()[r];if(h){var m=e;if("string"==typeof h)r=h,e=m.match(/^\{/)?m.substring(1,m.length-2):m;else if(h="number"==typeof h?h:h.id){var k=l[h];k&&(k={},l[h]=k);k[m]=b.none}}e=r=""}(a=l[a])&&f in a&&(a[f]=g)};this.onSyncSourceEnd=function(a,b){var e=b[a];d.getState()==
d.STATES.stop&&e.errCode!=o.ERRORS.ERR_NONE?h(e)!=null?this.fireSyncNotification(e,!0,e.errCode,""):this.fireAllSyncNotifications(!0,e.errCode,e.error,""):this.fireSyncNotification(e,!0,e.errCode,"");this.cleanCreateObjectErrors()};this.reportSyncStatus=function(){};this.fireAllSyncNotifications=function(a,b,e,f){d.getState()!=d.STATES.exit&&(b!=o.ERRORS.ERR_NONE&&!d.isSearch()&&this.reportSyncStatus("sync_failed_forall.",b,e),h(null)&&this.doFireSyncNotification(null,a,b,e,"",f))};this.fireSyncNotification=
function(a,b,e,f){if(d.getState()!=d.STATES.exit){if((f||e!=o.ERRORS.ERR_NONE)&&!d.isSearch())a!=null&&!f&&(f="sync_failed_for"+a.name+"."),this.reportSyncStatus(f,e,a!=null?a.error:"");this.doFireSyncNotification(a,b,e,"","","")}};this.doFireSyncNotification=function(a,b,e,f,m,l){if(!d.isStoppedByUser())try{var r=null,j="",s=b;if(r=h(a)){j="";a&&(j+="total_count="+a.totalCount,j+="&processed_count="+a.curPageCount,j+="&processed_objects_count="+(n[a.id]||0),j+="&cumulative_count="+a.serverObjectsCount,
j+="&source_id="+a.id,j+="&source_name="+a.name);j+=(j?"&":"")+(m||"sync_type=incremental");j+="&status=";if(b){if(e==o.ERRORS.ERR_NONE)j+=!a&&!m?"complete":"ok";else{if(d.isStoppedByUser())e=o.ERRORS.ERR_CANCELBYUSER;j+="error";j+="&error_code="+e;f?j+="&error_message="+f:a&&(j+="&error_message="+a.error);l?j+="&"+l:a&&a.serverError&&(j+="&"+a.serverError)}a&&(j+=p(a.id))}else j+="in_progress";j+="&rho_callback=1";(s=s&&r.removeAfterFire)&&this.clearNotification(a);k.info("Fire notification. Source: "+
(a?a.name:"")+"; "+r.toString());g(r,j)&&this.clearNotification(a)}}catch(v){k.error("Fire notification failed.",v)}};this.setNotification=function(a,b){a&&this.setSyncNotification(a.id,b)};this.setSyncNotification=function(a,b){k.info("Set notification. Source ID: "+a+";"+(b?b.toString():""));a==-1?C=b:s[a]=b};this.clearNotification=function(a){k.info("Clear notification. Source: "+(a?a.name:""));d.isSearch()?f=null:s[a.id]=null};this.clearSyncNotification=function(a){k.info("Clear notification. Source ID: "+
a);a==-1?C=null:s[a]=null};this.cleanLastSyncObjectCount=function(){n={}};this.incLastSyncObjectCount=function(a){var b=n[a]||0;b+=1;return(n[a]=b)||0};this.callLoginCallback=function(a,b,e){d.isStoppedByUser()||(b="error_code="+b,b+="&error_message="+(e!=null?e:""),b+="&rho_callback=1",k.info("Login callback: "+a.toString()+". Body: "+b),g(a,b))}},SyncNotification:j,byEvent:function(b){a(window).trigger(jQuery.Event(b),a.makeArray(arguments).slice(1))}}});a.extend(RhoConnect,{SyncNotification:j})})(jQuery);
"undefined"!=typeof Ext&&function(a,j){var o=null;j.data.RhoconnectStorageProxy=j.extend(j.data.ClientProxy,{LOG:new RhoConnect.rho.Logger("Rhoconnect.plugin-extjs.js"),dbName:void 0,constructor:function(a){j.data.RhoconnectStorageProxy.superclass.constructor.call(this,a);this.setReader(this.reader);if(this.getStorageObject()==void 0)throw"Rhoconnect Storage is not available, please ensure you have rhoconnect.js scripts properly loaded";this.dbName=this.dbName||(this.store?this.store.storeId:void 0);
if(this.dbName==void 0)throw"No database name was provided to the rhoconnect storage proxy. See Ext.data.RhoconnectStorageProxy documentation for details";this.initialize()},create:function(b,d,p){function h(){b.setCompleted();typeof d=="function"&&d.call(p||this,b)}var g=this,k=b.records,l;b.setStarted();var j=RhoConnect.rho.deferredMapOn(k);a.each(k,function(a,b){b.phantom?(b.phantom=!1,l=g.getNextId()):l=b.getId();g.setRecord(b,l).done(function(b){j.resolve(a,[b])}).fail(function(b,d){j.reject(a,
[b,d])})});j.when().done(function(){b.setSuccessful();h()}).fail(function(){h();g.LOG.error("update() object update error")})},read:function(a,d,p){function h(){var e=null;g.root?(e={},e.name=k,e[g.root]=r,e=l.read(e)):e=l.read(r);j.apply(a,{resultSet:e});a.setCompleted();typeof d=="function"&&d.call(p||g,a)}var g=this,k=g.model.modelName,l=g.getReader(),r=[];a.id?g.getRecord(a.id).done(function(d){d&&(r.push(d),a.setSuccessful());h()}).fail(function(a,b){g.LOG.error("read() single object read error: "+
b);h()}):g.findAll(k).done(function(d){r=d;a.setSuccessful();h()}).fail(function(a,b){g.LOG.error("read() all objects read error: "+b);h()})},update:function(b,d,j){function h(){b.setCompleted();typeof d=="function"&&d.call(j||this,b)}var g=this,k=b.records;b.setStarted();var l=RhoConnect.rho.deferredMapOn(k);a.each(k,function(a,b){g.setRecord(b).done(function(b){l.resolve(a,[b])}).fail(function(b,d){l.reject(a,[b,d])})});l.when().done(function(){b.setSuccessful();h()}).fail(function(){h();g.LOG.error("update() object update error")})},
destroy:function(b,d,j){function h(){b.setCompleted();typeof d=="function"&&d.call(j||this,b)}var g=this,k=b.records;b.setStarted();var l=RhoConnect.rho.deferredMapOn(k);a.each(k,function(a,b){g.removeRecord(b).done(function(b){l.resolve(a,[b])}).fail(function(b,d){l.reject(a,[b,d])})});l.when().done(function(){b.setSuccessful();h()}).fail(function(){h();g.LOG.error("update() object update error")})},findAll:function(b){function d(a,b){var d={},h=j.model.prototype.fields.items,e=h.length,m,f,o;for(m=
0;m<e;m++)f=h[m],o=f.name,d[o]=typeof f.decode=="function"?f.decode(b[o]):b[o];d.id=a;return d}var j=this,h=j.getStorageObject();return a.Deferred(function(g){function k(a){h.executeSql("SELECT * FROM object_values WHERE source_id=?",[a]).done(function(a,b){for(var d={},g=0;g<b.rows.length;g++){var h=b.rows.item(g).object,k=b.rows.item(g).attrib,j=b.rows.item(g).value,c=d;c[h]||(c[h]={});c[h][k]=j}l(d)}).fail(function(a,b){j.LOG.error("findAll() select all objects for source error: "+b);g.reject(a,
b)})}function l(b){var e=[];a.each(b,function(a,b){e.push(d(a,b))});g.resolve(e)}h.executeSql("SELECT source_id FROM sources WHERE name=? LIMIT 1 OFFSET 0",[b]).done(function(a,b){var d=null;b.rows&&b.rows.length&&b.rows.length>0&&(d=b.rows.item(0).source_id);k(d)}).fail(function(a,b){j.LOG.error("findAll() source_id select error: "+b);g.reject(a,b)})}).promise()},getRecord:function(b){function d(a){var d={},h=j.model.prototype.fields.items,o=h.length,e,m,f={};for(e=0;e<a.rows.length;e++)m=a.rows.item(e).attrib,
f[m]=a.rows.item(e).value;for(e=0;e<o;e++)a=h[e],m=a.name,d[m]=typeof a.decode=="function"?a.decode(f[m]):f[m];d.id=b;return d}var j=this,h=j.getStorageObject();return a.Deferred(function(a){h.executeSql("SELECT * FROM object_values WHERE object=?",[b.toString()]).done(function(b,h){a.resolve(d(h))}).fail(function(b,d){j.LOG.error("getRecord() error: "+d);a.reject(b,d)})}).promise()},setRecord:function(b,d){var j=this,h=j.getStorageObject(),g=j.model.modelName,k=null,l=!1;d?(b.setId(d),l=!0):d=b.getId();
var o=b.data,e={},m=j.model.prototype.fields.items;return a.Deferred(function(f){function s(){h.executeSql("SELECT attrib FROM object_values WHERE object=?",[d.toString()]).done(function(a,b){for(var d=0;d<b.rows.length;d++){var e=b.rows.item(d).attrib;e&&(v[e]=!0)}C()}).fail(function(a,b){j.LOG.error("setRecord() read attr names error: "+b);f.reject(a,b)})}function C(){h.rwTx().ready(function(f,c){a.each(m,function(a,f){var g=f.name;e[g]=typeof f.encode=="function"?f.encode(o[g],b):o[g];var m=v[g]?
"UPDATE object_values SET value=? WHERE source_id=? and object=? and attrib=?":"INSERT INTO object_values ( value, source_id, object, attrib ) VALUES (?, ?, ?, ?)",j=e[g];g!="id"&&(h.executeSql(m,[j,k.toString(),d.toString(),g],c),l||h.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",[j,k.toString(),d.toString(),g,"update"],c))});l&&h.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",
[null,k.toString(),d.toString(),"object","create"],c)}).done(function(){b.dirty=!1;f.resolve(d)}).fail(function(){f.reject(null,"setRecord() update/insert attr error")})}if(void 0!=b.dirty&&!b.dirty)f.resolve(d);else{h.executeSql("SELECT source_id FROM sources WHERE name=?",[g]).done(function(a,b){b.rows&&b.rows.length&&b.rows.length>0&&(k=b.rows.item(0).source_id);s()}).fail(function(a,b){j.LOG.error("setRecord() read source_id error: "+b);f.reject(a,b)});var v={}}}).promise()},removeRecord:function(b){var d=
this,j=d.getStorageObject(),h=d.model.modelName,g=null,k=null;if(b&&b.data&&b.data.id)k=b.data.id;return a.Deferred(function(l){function o(){j.rwTx().ready(function(b,d){function f(){function b(){a.each(h,function(a,b){j.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",[b,g.toString(),k.toString(),a,e],d)})}var e="delete";j.executeSql("SELECT update_type FROM changed_values WHERE object=? AND update_type=? AND sent=?",[k.toString(),"create",
0],d).done(function(d,c){0<c.rows.length&&(e=null);j.executeSql("DELETE FROM changed_values WHERE object=? AND source_id=? AND sent=?",[k.toString(),g.toString(),0],d).done(function(){var c=!1;a.each(h,function(){e&&(c=!0)});c&&b()})})}var h={};j.executeSql("SELECT * FROM object_values WHERE object=? AND source_id=?",[k.toString(),g.toString()],d).done(function(a,b){for(var d=0;d<b.rows.length;d++){var c=b.rows.item(d).attrib,e=b.rows.item(d).value;c&&(h[c]=e)}j.executeSql("DELETE FROM object_values WHERE object=? AND source_id=?",
[k.toString(),g.toString()],a).done(function(){f()})})}).done(function(){b.dirty=!1;l.resolve(k)}).fail(function(){l.reject(null,"setRecord() remove attr error")})}j.executeSql("SELECT source_id FROM sources WHERE name=?",[h]).done(function(a,b){b.rows&&b.rows.length&&b.rows.length>0&&(g=b.rows.item(0).source_id);o()}).fail(function(a,b){d.LOG.error("setRecord() read source_id error: "+b);l.reject(a,b)})}).promise()},initialize:function(){},clear:j.emptyFn,getStorageObject:function(){return RhoConnect.rho.storage},
getNextId:function(){o=o||Date.now()-(new Date(2009,1,1)).getTime();o+=1;return o}});j.data.ProxyMgr.registerType("rhoconnect",j.data.RhoconnectStorageProxy)}(jQuery,Ext);
