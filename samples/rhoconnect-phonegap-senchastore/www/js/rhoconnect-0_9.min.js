var RhoConnect=function(a){function k(e,b){return a.Deferred(function(j){g.storage.loadAllSources(e).done(function(e,h){var m=g.engine.getStartSourceId(h),f={};a.each(h,function(h,o){f[o.name]=o});var u={},d=[];a.each(b,function(f){var o=new a.Deferred;u[f]=o;d.push(o.promise())});a.each(b,function(h,o){var c=f[o.name];if(c){var a=!1;if(c.sync_priority!=o.sync_priority)c.sync_priority=o.sync_priority,a=!0;if(c.sync_type!=o.sync_type)c.sync_type=o.sync_type,a=!0;if(c.associations!=o.associations)c.associations=
o.associations,a=!0;if(!o.id)o.id=c.id;a&&g.storage.storeSource(c,e).done(function(c,f){u[h].resolve(f)}).fail(function(c,f){u[h].reject(c,f)})}else{if(!o.id)o.id=m,m=1;g.storage.insertSource(o,e).done(function(c,f){u[h].resolve(f)}).fail(function(c,f){u[h].reject(c,f)})}});a.when(d).done(function(){j.resolve()}).fail(function(f,o){j.reject(f,o)})}).fail(function(a,h){j.reject(a,h)})}).promise()}function n(e){return a.Deferred(function(b){a.each(e,function(a,e){e.associations=""});a.each(e,function(b,
d){d&&d.model&&d.model.belongsTo&&a.each(d.model.belongsTo,function(a,b){var f=e[b];if(f){var j=f.associations||"";j+=0<j.length?", ":"";j+=d.name+", "+a;f.associations=j}})});g.storage.open().done(function(a){g.storage.rwTx(a).ready(function(a,h){k(h,e).done(function(){b.resolve()}).fail(function(a,f){b.reject(a,f)})}).fail(function(a,h){b.reject(a,h)})})}).promise()}function b(b,l,j){function s(a){if(a&&!a.isLoaded&&(a.isLoaded=!0,"string"==typeof a.name)){var b=new g.domain.Model(a);b.source.sync_priority=
parseInt(a.sync_priority||1E3);b.source.sync_type="incremental";b.source.partition="user";var f=a.source_id?parseInt(a.source_id):null;if((b.source.id=f)&&g.engine.maxConfigSrcId<f)g.engine.maxConfigSrcId=f;d[a.name]=b;g.engine.getSources()[a.name]=b.source}}if(p)return a.Deferred().resolve().promise();l&&"object"==typeof l&&(a.isArray(l)?a.each(l,function(a,b){s(b)}):s(l));p=!0;return n(g.engine.getSources()).done(function(){a.each(g.engine.getSources(),function(a,b){g.engine.getNotify().setNotification(b,
new g.notify.SyncNotification(function(){if("function"==typeof j)return j(a),!1},!1))})})}var d={},p=!1,g={config:a.extend({},{appName:"rhoConnect",syncServer:"",pollInterval:20,database:{nameSuffix:"Db_",version:"1.0",comment:"RhoConnect database",size:2097152}},RhoConfig),EVENTS:{GENERIC_NOTIFICATION:"rhoConnectGenericNotification",ERROR:"rhoConnectError",CLIENT_CREATED:"rhoConnectClientCreated",STATUS_CHANGED:"rhoConnectStatusChanged",SYNCHRONIZING:"rhoConnectSourceSynchronizing",SYNC_SOURCE_END:"rhoConnectSourceSynchronizationEnd"},
getModels:function(){return d},domain:null,protocol:null,engine:null,notify:null,storage:null};return a.extend({ERRORS:{ERR_NONE:"No error",ERR_NETWORK:"Network error",ERR_REMOTESERVER:"Remote server access error",ERR_RUNTIME:"Runtime error",ERR_UNEXPECTEDSERVERRESPONSE:"Unexpected server response",ERR_DIFFDOMAINSINSYNCSRC:"Different synchronization domain error",ERR_NOSERVERRESPONSE:"No server response",ERR_CLIENTISNOTLOGGEDIN:"Client not logged in",ERR_CUSTOMSYNCSERVER:"Custom sync server",ERR_UNATHORIZED:"Unauthorized access",
ERR_CANCELBYUSER:"Canceled by user",ERR_SYNCVERSION:"Synchronization version error",ERR_GEOLOCATION:"Geolocation error"},init:function(e,l,j,s){return a.Deferred(function(a){g.storage.init(s).done(function(){g.engine.restoreSession().done(function(){d={};p=!1;b(l,e,j).done(function(){a.resolve()}).fail(function(b,f){a.reject("models load error: "+f)})}).fail(function(b,f){a.reject("session restoring error: "+f)})}).fail(function(b){a.reject("storage initialization error: "+b)})}).promise()},login:function(b,
d,j){return a.Deferred(function(a){g.engine.login(b,d,j).done(function(){a.resolve()}).fail(function(b,e){a.reject(b,e)})}).promise()},logout:function(){return g.engine.logout()},isLoggedIn:function(){return g.engine.isSessionExist()},syncAllSources:function(){return g.engine.doSyncAllSources()}},{rho:g})}(jQuery);
(function(a){function k(a){function d(a){window.console&&a(window.console)}function p(d,g){return Date().replace(/\S+\s(.*?)\sGMT\+.*$/,"$1")+" ["+e[d]+"] ("+a+") "+g}var g={trace:0,info:1,warning:2,error:3,fatal:4},e=["Trace","Info","Warning","Error","Fatal"],l="string"==typeof n.config.logLevel&&n.config.logLevel.toLowerCase()in g?g[n.config.logLevel.toLowerCase()]:g.warning;this.trace=function(a){var b=g.trace;l>b||d(function(e){e.info(p(b,a))})};this.info=function(a){var b=g.info;l>b||d(function(e){e.info(p(b,
a))})};this.warning=function(a,b){var e=g.warning;l>e||d(function(d){d.warn(p(e,a));b&&d.warn("EXCEPTION: "+b)})};this.error=function(a,b){var e=g.error;l>e||d(function(d){d.error(p(e,a));b&&d.error("EXCEPTION: "+b)})};this.fatal=function(a,b){var e=g.fatal;l>e||d(function(d){d.error(p(e,a));b&&d.error("EXCEPTION: "+b)})}}var n=RhoConnect.rho;a.extend(n,{Logger:k,ERRORS:RhoConnect.ERRORS,deferredMapOn:function(b){var d={},p=[];a.each(b,function(b){var e=new a.Deferred;d[b]=e;p.push(e.promise())});
return{resolve:function(a,b){d[a]&&d[a].resolve.apply(d[a],b)},reject:function(a,b){d[a]&&d[a].reject.apply(d[a],b)},when:function(){return a.when.apply(this,p)}}},passRejectTo:function(a){return function(){a.reject(arguments)}}});a.extend(RhoConnect,{Logger:k})})(jQuery);
(function(a){function k(a){for(var b=document.cookie.split(";"),d=0;d<b.length;d++){var g=b[d].split("=");if(g[0].replace(/^\s+|\s+$/g,"")==a)return 1<g.length?g[1].replace(/^\s+|\s+$/g,""):""}return null}function n(e,l,j,p){return a.Deferred(function(h){var m=(/\?/.test(e)?"&":"?")+d+"="+g;a.ajax({url:e+(g?m:""),type:j||"post",contentType:p||"application/json",processData:!1,data:a.toJSON(l),dataType:"json",headers:{"X-Origin":function(){var a=document.location;return a.href.substring(0,a.href.length-
a.pathname.length)}()},xhrFields:{withCredentials:!0}}).done(function(a,e,d){b.notify.byEvent(b.EVENTS.GENERIC_NOTIFICATION,e,a,d);h.resolve(e,a,d)}).fail(function(a,e,d){b.notify.byEvent(b.EVENTS.GENERIC_NOTIFICATION,e,d,a);h.reject(e,d,a)})}).promise()}var b=RhoConnect.rho,d="rhosync_session",p={HTTP_OK:200,HTTP_PARTIAL_CONTENT:206,HTTP_MOVED_TEMPORARILY:302,HTTP_MOVED_PERMANENTLY:301,HTTP_MOVED_PERM:301,HTTP_BAD_REQUEST:400,HTTP_NOT_FOUND:404,HTTP_UNAUTHORIZED:401,HTTP_RANGENOTSATISFY:416,HTTP_INTERNAL_ERROR:500,
HTTP_NOTMODIFIED:304},g=null;a.extend(b,{protocol:{getVersion:function(){return 3},getErrCodeFromXHR:function(a){switch(a.status){case p.HTTP_UNAUTHORIZED:return b.ERRORS.ERR_UNATHORIZED;case p.HTTP_OK:return b.ERRORS.ERR_NONE;case p.HTTP_PARTIAL_CONTENT:return b.ERRORS.ERR_NONE;default:return b.ERRORS.ERR_REMOTESERVER}},getSession:function(){return k(d)},setSession:function(){},deleteSession:function(){var a=d,b=window.location.hostname;if(k(a))document.cookie=a+"=; path=/"+(b?"; domain="+b:"")+
"; expires=Thu, 01-Jan-1970 00:00:01 GMT"},getServerQueryUrl:function(){return b.config.syncServer},login:function(e,l){return a.Deferred(function(a){n(b.config.syncServer+"/clientlogin",{login:e,password:l,rememberme:1}).done(function(b,e,l){e&&(g=e[d]||null);a.resolve(e,b,l)}).fail(function(b,d,e){a.reject(b,d,e)})}).promise()},logout:function(){g=null},clientCreate:function(){return n(b.config.syncServer+"/clientcreate","","get","text/plain")},clientReset:function(a){return n(b.config.syncServer+
"/clientreset",{client_id:a},"get","text/plain")},serverQuery:function(a,d,g,p){d="?version=3&client_id="+d+"&p_size="+g;d+=a?"&source_name="+a:"";d+=p?"&token="+p:"";return n(b.config.syncServer+d,"","get","text/plain")},postData:function(a){return n(b.config.syncServer+"",a)}}})})(jQuery);
(function(a){function k(a){this.id=null;this.fields=a.fields;this.values={};var d=!0;this.__defineGetter__("isNew",function(){return d});var p=!1;this.__defineGetter__("isChanged",function(){return p});var g=function(a,b){this.values[a]=b;p=!0};this.addField=function(a){this.__defineGetter__(a,function(){return this.values[a]});this.__defineSetter__(a,function(b){g(a,b)})};this.deleteField=function(a){this.__defineGetter__(a,void 0);this.__defineSetter__(a,void 0);delete this.fields[a];delete this.values[a]};
this.clearNotifications=function(){};this.destroy=function(){};this.updateAttributes=function(){this.save()};this.save=function(){p=d=!1}}var n=RhoConnect.rho;a.extend(n,{domain:{SyncObject:k,Model:function(a){this.source=new n.engine.Source(a.sourceId,a.name,"incremental",n.storage,n.engine,this);this.__defineGetter__("name",function(){return this.source.name});this.__defineSetter__("name",function(a){this.source.name=a});this.belongsTo=a.belongsTo;this.deleteAll=function(){};this.find=function(){};
this.findAll=function(){};this.findBySql=function(){};this.newObject=function(a){return new k(a)};this.createObject=function(a){a=this.newObject(a);a.save();return a};this.paginate=function(){};this.sync=function(){};this.setNotification=function(){};this.save=function(){};this.canModify=function(){}}}})})(jQuery);
(function(a){function k(b,d,e,t){return a.Deferred(function(a){var c=b||j.config.database.name,r=d||j.config.database.version,g=e||j.config.database.comment,l=t||j.config.database.size,m;h[c]||(h[c]={});h[c][r]||(h[c][r]=null);if(m=h[c][r])a.resolve(m);else try{var p=openDatabase(c,r,g,l);h[c]||(h[c]={});m=h[c][r]=p;a.resolve(m)}catch(s){a.reject(s)}}).promise()}function n(b,d){function e(a){var d="function"==typeof a.readTransaction?a.readTransaction:a.transaction;if(b&&b!="read-only")d=a.transaction;
try{d.apply(a,[function(b){t.resolve(a,b)},function(b){o.reject(a,b)},function(){o.resolve(a,"ok")}])}catch(h){o.reject(a,h.message)}}var t=a._Deferred(),o=a.Deferred();d?e(d):k().done(function(a){e(a)}).fail(function(a){o.reject(null,a)});o.promise();o.ready=t.done;return o}function b(b,d,e){return a.Deferred(function(a){function o(c,b,f){c.executeSql(b,f,function(c,b){a.resolve(c,b)},function(c,b){a.reject(c,b)})}if(e)o(e,b,d);else{var c=!b.match(/^\s*select\s+/i);n(c).ready(function(a,c){o(c,b,
d)}).done(function(c,b){a.resolve(c,b)}).fail(function(c,b){a.reject(c,b)})}}).promise()}function d(f,d){function e(a,f){var d=o[c];if(0<f.length){var t=f.shift();b(t,null,a).done(function(a,b){d.resolve(a,b,t);c++;e(a,f)}).fail(function(a,c){d.reject(a,c)})}}var t=f.replace(/^\s+|;\s*$/,"").split(";"),o=[],c=0,r=a.Deferred();o.push(r);c++;a.each(t,function(){o.push(a.Deferred())});d?e(d,t):n("read-write").ready(function(a,c){e(c,t)}).done(function(a,c){r.resolve(a,c)}).fail(function(a,c){r.reject(a,
c)});var h=[];a.each(o,function(a,c){h.push(c.promise())});return a.when.apply(this,h)}function p(){return d(s)}function g(f){return a.Deferred(function(a){b("SELECT name FROM sqlite_master WHERE type='table'",null,f).done(function(b,f){for(var d=[],c=0;c<f.rows.length;c++)d.push(f.rows.item(c).name);a.resolve(b,d)}).fail(function(b,f){a.reject(b,f)})}).promise()}function e(f,d,e){return a.Deferred(function(a){b(e?"INSERT INTO client_info ( session, token, token_sent, reset, port, last_sync_success, client_id ) VALUES (?, ?, ?, ?, ?, ?, ?)":
"UPDATE client_info SET session = ?, token = ?, token_sent = ?, reset = ?, port = ?, last_sync_success = ? WHERE client_id = ?",[f.session,f.token,f.token_sent,f.reset,f.port,f.last_sync_success,f.id],d).done(function(b){a.resolve(b,f)}).fail(function(b,c){a.reject(b,c)})}).promise()}function l(f,d,e){return a.Deferred(function(a){b(e?"INSERT INTO sources ( name, token, sync_priority, partition, sync_type, metadata, last_updated, last_inserted_size, last_deleted_size, last_sync_duration, last_sync_success, backend_refresh_time, source_attribs, schema, schema_version, associations, blob_attribs, source_id ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)":
"UPDATE sources SET name = ?, token = ?, sync_priority = ?, partition = ?, sync_type = ?, metadata = ?, last_updated = ?, last_inserted_size = ?, last_deleted_size = ?, last_sync_duration = ?, last_sync_success = ?, backend_refresh_time = ?, source_attribs = ?, schema = ?, schema_version = ?, associations = ?, blob_attribs = ? WHERE source_id = ?",[f.name,f.token,f.sync_priority,f.partition,f.sync_type,f.metadata,f.last_updated,f.last_inserted_size,f.last_deleted_size,f.last_sync_duration,f.last_sync_success,
f.backend_refresh_time,f.source_attribs,f.schema,f.schema_version,f.associations,f.blob_attribs,f.id],d).done(function(b){a.resolve(b,f)}).fail(function(b,c){a.reject(b,c)})}).promise()}var j=RhoConnect.rho,s='DROP TABLE IF EXISTS client_info;CREATE TABLE client_info ( "client_id" VARCHAR(255) default NULL, "session" VARCHAR(255) default NULL, "token" VARCHAR(255) default NULL, "token_sent" BIGINT default 0, "reset" BIGINT default 0, "port" VARCHAR(10) default NULL, "last_sync_success" VARCHAR(100) default NULL);DROP TABLE IF EXISTS object_values;CREATE TABLE object_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL);DROP TABLE IF EXISTS changed_values;CREATE TABLE changed_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL, "attrib_type" varchar(255) default NULL, "update_type" varchar(255) default NULL, "sent" BIGINT default 0);DROP TABLE IF EXISTS sources;CREATE TABLE sources ( "source_id" BIGINT PRIMARY KEY, "name" VARCHAR(255) default NULL, "token" BIGINT default NULL, "sync_priority" BIGINT, "partition" VARCHAR(255), "sync_type" VARCHAR(255), "metadata" varchar default NULL, "last_updated" BIGINT default 0, "last_inserted_size" BIGINT default 0, "last_deleted_size" BIGINT default 0, "last_sync_duration" BIGINT default 0, "last_sync_success" BIGINT default 0, "backend_refresh_time" BIGINT default 0, "source_attribs" varchar default NULL, "schema" varchar default NULL, "schema_version" varchar default NULL, "associations" varchar default NULL, "blob_attribs" varchar default NULL);DROP INDEX IF EXISTS by_src_id;CREATE INDEX by_src_id on object_values ("source_id");DROP INDEX IF EXISTS by_src_object;CREATE UNIQUE INDEX by_src_object ON object_values ("object", "attrib", "source_id");DROP INDEX IF EXISTS by_src_value;CREATE INDEX by_src_value ON object_values ("attrib", "source_id", "value");',
h={},m=new function(){this.blobAttrs={};this.srcNames={};this.initAttrManager=function(){return this.loadAttrs()};this.isBlobAttr=function(a,b){var d=this.blobAttrs[a];return d?b in d:!1};this.loadAttrs=function(){var b=this;return a.Deferred(function(d){b.blobAttrs={};var e="SELECT source_id,";e+="blob_attribs,name from sources";j.storage.executeSql(e).done(function(e,o){for(var c=0;c<o.rows.length;c++){var r=o.rows.item(0).source_id,h=o.rows.item(0).blob_attribs;if(!h)return;var g=new {},j="";a.each(h.split(","),
function(a,c){c&&(j?(g[j]=+c,j=""):j=c)});b.blobAttrs[r]=g;b.srcNames!=null&&(b.srcNames[o.rows.item(c).name.toUpperCase()]=r)}d.resolve()}).fail(function(a,b){d.reject(a,b)})}).promise()}};a.extend(j,{storage:{attrManager:m,listClientsId:function(d){return a.Deferred(function(a){b("SELECT client_id FROM client_info",null,d).done(function(b,d){for(var f=[],c=0;c<d.rows.length;c++)f.push(d.rows.item(c).client_id);a.resolve(b,f)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadClient:function(d,
e){return a.Deferred(function(a){b("SELECT * FROM client_info WHERE client_id = ?",[d],e).done(function(b,e){if(0==e.rows.length)a.reject(d,"Not found");else{var c=new j.engine.Client(d);c.session=e.rows.item(0).session;c.token=e.rows.item(0).token;c.token_sent=e.rows.item(0).token_sent;c.reset=e.rows.item(0).reset;c.port=e.rows.item(0).port;c.last_sync_success=e.rows.item(0).last_sync_success;a.resolve(b,c)}}).fail(function(b,d){a.reject(b,d)})}).promise()},loadAllClients:function(d){return a.Deferred(function(a){b("SELECT * FROM client_info",
null,d).done(function(b,d){for(var f=[],c=0;c<d.rows.length;c++){var e=new j.engine.Client(d.rows.item(c).client_id);e.session=d.rows.item(c).session;e.token=d.rows.item(c).token;e.token_sent=d.rows.item(c).token_sent;e.reset=d.rows.item(c).reset;e.port=d.rows.item(c).port;e.last_sync_success=d.rows.item(c).last_sync_success;f.push(e)}a.resolve(b,f)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeClient:e,insertClient:function(a,b){return e(a,b,!0)},deleteClient:function(d,e){var h="object"==
typeof d?d.id:d;return a.Deferred(function(a){b("DELETE FROM client_info WHERE client_id = ?",[h],e).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},listSourcesId:function(d){return a.Deferred(function(a){b("SELECT source_id FROM sources",null,d).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++)e.push(d.rows.item(c).source_id);a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadSource:function(d,e){return a.Deferred(function(a){b("SELECT * FROM sources WHERE source_id = ?",
[d],e).done(function(b,e){if(0==e.rows.length)a.reject(d,"Not found");else{var c=new j.engine.Source(e.rows.item(0).source_id,e.rows.item(0).name,e.rows.item(0).sync_type,j.storage,j.engine);c.token=e.rows.item(0).token;c.sync_priority=e.rows.item(0).sync_priority;c.partition=e.rows.item(0).partition;c.sync_type=e.rows.item(0).sync_type;c.metadata=e.rows.item(0).metadata;c.last_updated=e.rows.item(0).last_updated;c.last_inserted_size=e.rows.item(0).last_inserted_size;c.last_deleted_size=e.rows.item(0).last_deleted_size;
c.last_sync_duration=e.rows.item(0).last_sync_duration;c.last_sync_success=e.rows.item(0).last_sync_success;c.backend_refresh_time=e.rows.item(0).backend_refresh_time;c.source_attribs=e.rows.item(0).source_attribs;c.schema=e.rows.item(0).schema;c.schema_version=e.rows.item(0).schema_version;c.associations=e.rows.item(0).associations;c.blob_attribs=e.rows.item(0).blob_attribs;c.parseAssociations();a.resolve(b,c)}}).fail(function(b,d){a.reject(b,d)})}).promise()},loadAllSources:function(d){return a.Deferred(function(a){b("SELECT * FROM sources ORDER BY sync_priority",
null,d).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++){var f=new j.engine.Source(d.rows.item(c).source_id,d.rows.item(c).name,d.rows.item(c).sync_type,j.storage,j.engine);f.token=d.rows.item(c).token;f.sync_priority=d.rows.item(c).sync_priority;f.partition=d.rows.item(c).partition;f.sync_type=d.rows.item(c).sync_type;f.metadata=d.rows.item(c).metadata;f.last_updated=d.rows.item(c).last_updated;f.last_inserted_size=d.rows.item(c).last_inserted_size;f.last_deleted_size=d.rows.item(c).last_deleted_size;
f.last_sync_duration=d.rows.item(c).last_sync_duration;f.last_sync_success=d.rows.item(c).last_sync_success;f.backend_refresh_time=d.rows.item(c).backend_refresh_time;f.source_attribs=d.rows.item(c).source_attribs;f.schema=d.rows.item(c).schema;f.schema_version=d.rows.item(c).schema_version;f.associations=d.rows.item(c).associations;f.blob_attribs=d.rows.item(c).blob_attribs;f.parseAssociations();e.push(f)}a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeSource:l,insertSource:function(a,
b){return l(a,b,!0)},deleteSource:function(d,e){var h="object"==typeof d?d.id:d;return a.Deferred(function(a){b("DELETE FROM sources WHERE source_id = ?",[h],e).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},init:function(b){return a.Deferred(function(a){g().done(function(d,e){(5!=e.length||b)&&p().done(function(){a.resolve(null,"db schema initialized")}).fail(function(b,c){a.reject(b,"db schema initialization error: "+c)});a.resolve(null,"db schema is ok")}).fail(function(b,
d){a.reject(b,"db tables read error: "+d)})}).promise()},open:k,tx:n,roTx:function(a){return n(!1,a)},rwTx:function(a){return n("read-write",a)},executeSql:b,executeBatchSql:d,initSchema:p,getAllTableNames:g}})})(jQuery);
(function(a){function k(){return N=N||new i.notify.SyncNotify(i.engine)}function n(){return O}function b(){return G}function d(){return a.Deferred(function(a){A="";i.storage.executeSql("SELECT session FROM client_info").done(function(c,b){for(var d=0;d<b.rows.length;d++){var e=b.rows.item(d).session;if(e){A=e;break}}a.resolve()}).fail(q(a))}).promise()}function p(){return a.Deferred(function(a){i.storage.executeSql("UPDATE client_info SET session = NULL").done(function(){A="";i.protocol.logout();
a.resolve()}).fail(q(a))}).promise()}function g(c,b,d){return a.Deferred(function(a){H=!1;i.protocol.login(c,b).done(function(){A=c;i.config.database.name=i.config.appName+i.config.database.nameSuffix+c;A||J.error("Server responds with empty session cookie.");i.storage.init().done(function(){if(A)H?a.reject(i.ERRORS.ERR_CANCELBYUSER,"Stopped by user"):e(c).done(function(){i.config.rho_sync_user=name;k().callLoginCallback(d,i.ERRORS.ERR_NONE,"");a.resolve()}).fail(v(a));else{J.error("DB doesn't contains this session.");
var b=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;k().callLoginCallback(d,b,"");a.reject(b,"")}}).fail(v(a))}).fail(function(c,b,e){c=i.protocol.getErrCodeFromXHR(e);if(h(b))c=i.ERRORS.ERR_NOSERVERRESPONSE;c!=i.ERRORS.ERR_NONE&&k().callLoginCallback(d,c,e.responseText);a.reject(c,b)})}).promise()}function e(c){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b){if(0<b.length)i.storage.executeSql("UPDATE client_info SET session=?",[c]).done(function(){a.resolve(b[0])}).fail(q(a));else{var d=
new K(null);d.session=c;i.storage.insertClient(d).done(function(c,b){a.resolve(b)}).fail(q(a))}}).fail(q(a))}).promise()}function l(c){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b,d){if(0<d.length)i.storage.executeSql("UPDATE client_info SET client_id=?",[c]).done(function(){a.resolve(c)}).fail(q(a));else{var e=new K(null);e.id=c;i.storage.insertClient(e).done(function(){a.resolve(c)}).fail(q(a))}}).fail(q(a))}).promise()}function j(){return a.Deferred(function(a){i.protocol.clientCreate().done(function(c,
b){b&&b.client&&b.client.client_id?l(b.client.client_id).done(function(c){a.resolve(c)}).fail(v(a)):a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,b)}).fail(function(c,b){var d=h(b)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;a.reject(d,b)})}).promise()}function s(c){return a.Deferred(function(a){i.protocol.clientReset(c).done(function(c,b){b&&b.sources?a.resolve():a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,b)}).fail(function(c,b){var d=h(b)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;
a.reject(d,b)})}).promise()}function h(a){return a&&a.match(/time(d)?\s+out/i)}function m(){return a.Deferred(function(a){f(w.syncAllSources,null).done(function(){I()?r().done(function(){if(y!=w.exit)y=w.none;k().cleanCreateObjectErrors();a.resolve()}).fail(function(c,b){if(y!=w.exit)y=w.none;i.notify.byEvent(i.EVENTS.ERROR,"Sync failed",b);a.reject(c,b)}):(k().cleanCreateObjectErrors(),a.resolve())}).fail(function(c,b){a.reject(c,b)})}).promise()}function f(c,b){return a.Deferred(function(a){y=c;
O=c==w.search;H=!1;B=i.ERRORS.ERR_NONE;F="";G=!1;o().done(function(){C().done(function(c){function d(){var a=null;b&&(a=u("id",b));a?(a.errCode=B,a.error=F,k().fireSyncNotification(a,!0,a.errCode,"")):k().fireAllSyncNotifications(!0,B,F,"")}A=c;L()?t().done(function(c){P=c;B==i.ERRORS.ERR_NONE?(k().cleanLastSyncObjectCount(),a.resolve()):(d(),E(),a.reject(B,F))}).fail(v(a)):(B=i.ERRORS.ERR_CLIENTISNOTLOGGEDIN,d(),E(),a.reject(B,F))}).fail(v(a))}).fail(v(a))}).promise()}function u(a,c){for(var b=0;b<
x.length;b++)if(x[b][a]==c)return x[b];return null}function C(){return a.Deferred(function(a){i.storage.loadAllClients().done(function(c,b){for(var d=null,e=0;e<b.length;e++)if(b[e].session){d=b[e].session;break}a.resolve(d)}).fail(q(a))}).promise()}function t(){return a.Deferred(function(a){var c="",b=!1;i.storage.loadAllClients().done(function(d,e){var f=null;if(0<e.length)f=e[0],c=f.id,b=f.reset;c?b?s(c).done(function(c){f.reset=0;i.storage.storeClient(f).done(function(){a.resolve(c)}).fail(function(c,
b){E();q(a)(c,b)})}).fail(function(c,b){E();a.reject(c,b)}):a.resolve(c):j().done(function(c){a.resolve(c)}).fail(v(a))}).fail(q(a))}).promise()}function o(){return a.Deferred(function(b){D={};i.storage.loadAllSources().done(function(d,e){a.each(e,function(a,c){if(c.sync_type!="none")c.storage=i.storage,c.engine=i.engine,D[c.name]=c});c();b.resolve()}).fail(q(b))}).promise()}function c(){function c(a,b,d){if(b>=a.length)return a.concat(d);b<0&&(b=0);return a.slice(0,b).concat(d,a.slice(b))}function b(a,
c){for(var d=0;d<a.length;d++)if(c==a[d].name)return d;return-1}var d={},e=[];a.each(D,function(a,c){e.push(c)});e.sort(function(a,c){if(a.sync_priority<c.sync_priority)return-1;if(a.sync_priority>c.sync_priority)return 1;return 0});for(var f=e.length-1;f>0;){var i=e[f];if(i.getAssociations().length==0||i.name in d)f--;else for(var h=f,g=0;g<i.getAssociations().length;g++){var j=i.getAssociations()[g],j=b(e,j.m_strSrcName);j>=0&&j<h&&(e.splice(h,1),c(e,j,i),h=j)}d[i.name]=!0}D={};a.each(e,function(a,
c){D[c.name]=c});x=e}function r(){return a.Deferred(function(c){var b=!1,d={};a.each(x,function(a,c){d[c.name]=c});var e=i.deferredMapOn(a.extend({},d,{rhoStartSyncSource:"noMatterValue_itUseJustKeys"})),f=[],h=Q(),g=0<=h?x[h]:null;0<=h?M(h).done(function(){e.resolve("rhoStartSyncSource",["ok"])}).fail(function(a,c){b=!0;f.push({source:g.name,errCode:a,error:c});e.resolve("rhoStartSyncSource",["error",a,c])}):e.resolve("rhoStartSyncSource",["ok"]);a.each(x,function(a,c){M(a).done(function(){e.resolve(c.name,
["ok"])}).fail(function(a,d){b=!0;f.push({source:c.name,errCode:a,error:d});e.resolve(c.name,["error",a,d])})});e.when().done(function(){!b&&!G?(k().fireSyncNotification(null,!0,i.ERRORS.ERR_NONE,"sync_completed"),c.resolve(i.ERRORS.NONE,"Sync completed")):c.reject('Error for source"'+f[0].source+'": '+(f[0].error||f[0].errCode))}).fail(function(){J.error("Implementation error in SyncEngine.syncAllSources: some source has been rejected!");c.reject(f)})}).promise()}function Q(){for(var a=0;a<x.length;a++)if(!x[a].isEmptyToken())return a;
return-1}function M(c){return a.Deferred(function(a){var b=x[c];if(b.sync_type=="bulk_sync_only")a.resolve(null);else if(L()&&y!=w.stop){b.sync().done(function(){a.resolve(b)}).fail(function(c,d){if(b.errCode==i.ERRORS.ERR_NONE)b.errCode=i.ERRORS.ERR_RUNTIME;y=w.stop;a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped: "+d)}).then(d,d);var d=function(){k().onSyncSourceEnd(c,x)}}else a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped")}).promise()}function R(){return y}function S(a){y=a}function I(){var a=
y;return a!=w.exit&&a!=w.stop}function E(){if(I())y=w.stop}function T(c){var b=0;a.each(c,function(a,c){b=c.id>b?c.id:b});b<i.engine.maxConfigSrcId?b=i.engine.maxConfigSrcId+2:b+=1;return b}function U(){return V}function W(){return!1}function L(){return A?!0:!1}function X(c,b,d,e,f){function g(a,c){this.m_strSrcName=a;this.m_strAttrib=c}function j(a,c){this.m_strAttrib=a;this.m_strValue=c;this.m_strBlobSuffix="";if("string"==typeof this.m_strAttrib&&this.m_strAttrib.match(/\-rhoblob$/))this.m_strBlobSuffix=
"-rhoblob",this.m_strAttrib=this.m_strAttrib.substring(0,this.m_strAttrib.length-this.m_strBlobSuffix.length)}function m(){return a.Deferred(function(c){function b(d,e){for(var f=[],h=[],g=[],z=0;z<e.rows.length;z++)f.push(e.rows.item(z).object),g.push(e.rows.item(z).source_id),h.push(e.rows.item(z).update_type);var j=i.deferredMapOn(f);a.each(f,function(a,b){i.storage.executeSql("SELECT name, schema FROM sources WHERE source_id=?",[g[a]],d).done(function(d,e){var f=!1,z="object_values";if(e.rows.length>
0)(f=e.rows.item(0).schema)&&(z=e.rows.item(0).name);if(f)j.resolve(a,[]);else{i.storage.executeSql("SELECT attrib, value FROM "+z+" where object=? and source_id=?",[b,g[a]],d).done(function(a,c){r(a,c)}).fail(q(c));var r=function(d,e){for(var f=0;f<e.rows.length;f++){var z=e.rows.item(f).attrib,r=e.rows.item(f).value,m=i.storage.attrManager.isBlobAttr(g[a],z)?"blob.file":"";i.storage.executeSql("INSERT INTO changed_values (source_id,object,attrib,value,update_type,attrib_type,sent) VALUES(?,?,?,?,?,?,?)",
[g[a],b,z,r,h[a],m,0],d).done(function(){}).fail(q(c))}j.resolve(a,[])}}}).fail(function(c,b){j.reject(a,[c,b])})});j.when().done(function(){i.storage.executeSql("DELETE FROM changed_values WHERE attrib=?",["object"],d)}).fail(q(c))}i.storage.rwTx().ready(function(a,c){i.storage.executeSql("SELECT object, source_id, update_type FROM changed_values where attrib = 'object' and sent=0",[],c).done(function(a,c){0!=c.rows.length&&b(a,c)})}).done(function(){c.resolve()}).fail(function(a,b){q(c)(a,b)})}).promise()}
var r=new i.Logger("SyncSource");this.storage=e;this.engine=f;this.id=c;this.name=b;this.partition=this.sync_priority=this.token=null;this.sync_type=d;this.metadata=null;this.backend_refresh_time=this.last_sync_success=this.last_sync_duration=this.last_deleted_size=this.last_inserted_size=this.last_updated=0;this.blob_attribs=this.associations=this.schema_version=this.schema=this.source_attribs=null;this.arAssociations=[];this.getAssociations=function(){return this.arAssociations};this.isTokenFromDb=
!0;this.errCode=i.ERRORS.ERR_NONE;this.serverError=this.error="";this.deletedCount=this.insertedCount=this.serverObjectsCount=this.curPageCount=this.totalCount=0;this.getAtLeastOnePage=!1;this.refreshTime=0;this.multipartItems=[];this.blobAttrs=[];this.schemaSource=!1;this.progressStep=-1;this.isEmptyToken=function(){return this.token==0};this.setToken=function(a){this.token=a;this.isTokenFromDb=!1};this.processToken=function(c){var b=this;return a.Deferred(function(a){c>1&&b.token==c?(b.setToken(c),
a.resolve()):(b.setToken(c),i.storage.executeSql("UPDATE sources SET token=? where source_id=?",[+b.token,b.id]).done(function(){a.resolve()}).fail(q(a)))}).promise()};this.parseAssociations=function(c){var b=this;if(c){var d="";a.each(c.split(","),function(a,c){d?(b.arAssociations.push(new g(d,c)),d=""):d=c})}};this.syncServerChanges=function(){var c=this;return a.Deferred(function(a){function b(){c.curPageCount=0;var f=i.protocol.getServerQueryUrl(""),h=c.engine.getClientId(),g=c.engine.getSyncPageSize(),
j=!c.isTokenFromDb&&c.token>1?c.token:null;r.info("Pull changes from server. Url: "+(f+d(c.name,h,g,j)));i.protocol.serverQuery(c.name,h,g,j).done(function(d,f){c.processServerResponse_ver3(f).done(function(){function d(){c.token&&c.engine.isContinueSync()?b():e||(e=!0,c.engine.isSchemaChanged()&&c.engine.stopSync(),a.resolve())}c.engine.getSourceOptions().getBoolProperty(c.id,"pass_through")?c.processToken(0).done(function(){d()}).fail(function(c,b){v(a)(c,b)}):d()}).fail(function(c,b){v(a)(c,b)})}).fail(function(b,
d,e){c.engine.stopSync();c.errCode=i.protocol.getErrCodeFromXHR(e);c.error=d;a.reject(B,d)})}function d(a,c,b,e){c="?client_id="+c+"&p_size="+b+"&version=3";c+=a?"&source_name="+a:"";return c+(e?"&token="+e:"")}r.info("Sync server changes source ID :"+c.id);b();var e=!1}).promise()};this.processServerResponse_ver3=function(c){var b=this;return a.Deferred(function(a){function d(){function h(){function d(){b.curPageCount>0&&b.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"");a.resolve()}
r.info("Got "+b.curPageCount+"(Processed: "+b.serverObjectsCount+") records of "+b.totalCount+" from server. Source: "+b.name+". Version: "+f.version);if(b.engine.isContinueSync()){f=c[e];e++;var g=f;void 0!=g["schema-changed"]?(b.engine.setSchemaChanged(!0),d()):b.processServerErrors(g)?d():i.storage.rwTx().ready(function(c,e){function f(){function c(){void 0!=g.links&&b.engine.isContinueSync()&&b.processSyncCommand("links",g.links,!0,e);void 0!=g["delete"]&&b.engine.isContinueSync()&&b.processSyncCommand("delete",
g["delete"],!0,e);void 0!=g.insert&&b.engine.isContinueSync()&&b.processSyncCommand("insert",g.insert,!0,e);b.getNotify().fireObjectsNotification();d()}void 0!=g.metadata&&b.engine.isContinueSync()?i.storage.executeSql("UPDATE sources SET metadata=? WHERE source_id=?",[g.metadata,b.id],e).done(function(){c()}).fail(q(a)):c()}b.engine.getSourceOptions().getBoolProperty(b.id,"pass_through")?b.schemaSource||i.storage.executeSql("DELETE FROM object_values WHERE source_id=?",[b.id],e).done(function(){f()}).fail(q(a)):
f()}).done(function(){a.resolve()}).fail(function(c,b){q(a)(c,b)})}else d()}f=c[e];void 0!=f.source&&e++;f=c[e];if(void 0!=f.count)e++,b.curPageCount=+f.count;f=c[e];if(void 0!=f.refresh_time)e++,b.refreshTime=+f.refresh_time;f=c[e];void 0!=f.progress_count&&e++;f=c[e];if(void 0!=f.total_count)e++,b.totalCount=+f.total_count;b.token==0?i.storage.executeSql("DELETE FROM changed_values where source_id=? and sent>=3",[b.id]).done(function(){h()}).fail(q(a)):h()}var e=0,f=null,f=c[e];if(void 0!=f.version&&
(e++,f.version!=i.protocol.getVersion())){r.error("Sync server send data with incompatible version. Client version: "+i.protocol.getVersion()+"; Server response version: "+f.version+". Source name: "+b.name);b.engine.stopSync();b.errrCode=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;a.reject(b.errCode,"Sync server send data with incompatible version.");return}f=c[e];void 0!=f.token?(e++,b.processToken(+f.token).done(function(){d()}).fail(function(c,d){a.reject(b.errCode,d)})):d()}).promise()};this.processSyncCommand=
function(c,b,d,e){var f=this;return a.Deferred(function(h){var g=i.deferredMapOn(b);a.each(b,function(b,h){function j(){g.resolve(b,[e]);if(f.sync_type!="none"&&d){var a=f.getNotify().incLastSyncObjectCount(f.id);f.progressStep>0&&a%f.progressStep==0&&f.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"")}}f.engine.isContinueSync()&&(f.schemaSource||a.each(h,function(a,d){f.engine.isContinueSync()&&f.processServerCmd_Ver3(c,b,a,d,e).done(function(){j()}).fail(function(a,c){r.error("Sync of server changes failed for "+
f.name+"; object: "+b,c);g.reject(b,[a,c])})}))});g.when().done(function(){h.resolve(e)}).fail(v(h))}).promise()};this.processServerCmd_Ver3=function(c,b,d,e,f){var h=this;return a.Deferred(function(a){var g=new j(d,e);if(c=="insert"){i.storage.executeSql("SELECT source_id FROM object_values WHERE object=? and attrib=? and source_id=? LIMIT 1 OFFSET 0",[b,g.m_strAttrib,h.id],f).done(function(c,d){0==d.rows.length?i.storage.executeSql("INSERT INTO object_values (attrib, source_id, object, value) VALUES(?,?,?,?)",
[g.m_strAttrib,h.id,b,g.m_strValue],c).done(function(){r()}).fail(q(a)):i.storage.executeSql("UPDATE object_values SET value=? WHERE object=? and attrib=? and source_id=?",[g.m_strValue,b,g.m_strAttrib,h.id],c).done(function(c){h.sync_type!="none"?i.storage.executeSql("UPDATE changed_values SET sent=4 where object=? and attrib=? and source_id=? and sent>1",[b,g.m_strAttrib,h.id],c).done(function(){r()}).fail(q(a)):r()}).fail(q(a))}).fail(q(a));var r=function(){if(h.sync_type!="none")h.getNotify().onObjectChanged(h.id,
b,i.notify.ACTIONS.update);h.insertedCount++;a.resolve(f)}}else c=="delete"?i.storage.executeSql("DELETE FROM object_values where object=? and attrib=? and source_id=?",[b,g.m_strAttrib,h.id],f).done(function(c){h.sync_type!="none"?(h.getNotify().onObjectChanged(h.id,b,i.notify.ACTIONS["delete"]),i.storage.executeSql("UPDATE changed_values SET sent=3 where object=? and attrib=? and source_id=?",[b,g.m_strAttrib,h.id],c).done(function(){h.deletedCount++;a.resolve(c)}).fail(q(a))):(h.deletedCount++,
a.resolve(c))}).fail(q(a)):c=="links"&&h.processAssociations(b,g.m_strValue,f).done(function(c){i.storage.executeSql("UPDATE object_values SET object=? where object=? and source_id=?",[g.m_strValue,b,h.id],c).done(function(){i.storage.executeSql("UPDATE changed_values SET object=?,sent=3 where object=? and source_id=?",[g.m_strValue,b,h.id],c).done(function(){h.getNotify().onObjectChanged(h.id,b,i.notify.ACTIONS.create);a.resolve(c)}).fail(q(a))}).fail(q(a))}).fail(v(a))}).promise()};this.processAssociations=
function(c,b,d){var e=this;return a.Deferred(function(a){if(e.associations.length==0)a.resolve();else{for(var h=i.deferredMapOn(e.associations),g=0;g<e.associations.length;g++){var j=f.findSourceBy("name",e.associations[g].m_strSrcName);j&&j.updateAssociation(c,b,e.associations[g].m_strAttrib,d).done(function(){h.resolve(g,[])}).fail(function(a,c){h.reject(g,[a,c])})}h.when().done(function(){a.resolve(d)}).fail(v(a))}}).promise()};this.updateAssociation=function(c,b,d,e){var f=this;return a.Deferred(function(a){function h(){i.storage.executeSql("UPDATE changed_values SET value=? where attrib=? and source_id=? and value=?",
[b,d,f.id,c],e).done(function(){a.resolve(e)}).fail(q(a))}f.schemaSource?h():i.storage.executeSql("UPDATE object_values SET value=? where attrib=? and source_id=? and value=?",[b,d,f.id,c],e).done(function(){h()}).fail(q(a))}).promise()};this.processServerErrors=function(c){function b(d){f=!0;e.ErrCode=i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(c[d],function(a,c){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(a)+"][message]="+encodeURI(c.message)})}function d(b){f=!0;e.ErrCode=
i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(c[b],function(c,d){c.match(/-error$/i)?(c=c.substring(0,c.length-6),e.serverError+=e.serverError?"&":"",e.serverError+="server_errors["+encodeURI(b)+"]["+encodeURI(c)+"][message]="+encodeURI(d.message)):a.each(d,function(a,d){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(b)+"]["+encodeURI(c)+"][attributes]["+encodeURI(a)+"]="+encodeURI(d)})})}var e=this,f=!1;a.each(c,function(a){a.match(/^(source|search)-error$/i)?b(a):a.match(/-error$/i)&&
d(a)});return f};this.syncClientChanges=function(){var c=this;return a.Deferred(function(a){function b(){c.isPendingClientChanges().done(function(b){d&&b?(r.info("Server does not sent created items. Stop sync."),c.engine.setState(w.stop),a.resolve(d)):i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? LIMIT 1 OFFSET 0",[c.id]).done(function(b,e){var f=!1;(f=e.rows&&e.rows.length&&0<e.rows.length)?c.doSyncClientChanges().done(function(){d=!1;a.resolve(d)}).fail(v(a)):a.resolve(d)}).fail(q(a))}).fail(q(a))}
var d=!1;c.isPendingClientChanges().done(function(e){e?(r.info("Client has unconfirmed created items. Call server to update them."),c.syncServerChanges().done(function(){d=!0;b()}).fail(v(a))):b()}).fail(q(a))}).promise()};this.isPendingClientChanges=function(){var c=this;return a.Deferred(function(a){i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? and update_type='create' and sent>1  LIMIT 1 OFFSET 0",[c.id]).done(function(c,b){a.resolve(b.rows&&b.rows.length&&0<b.rows.length)}).fail(function(c,
b){a.reject(c,b)})}).promise()};this.doSyncClientChanges=function(){var c=this;return a.Deferred(function(b){function d(){function e(){var d=i.deferredMapOn(f);a.each(f,function(a,b){c.engine.isContinueSync()&&b?a=="create"?c.storage.executeSql("UPDATE changed_values SET sent=2 WHERE source_id=? and update_type=? and sent=1",[c.id,a]).done(function(){d.resolve(a,[])}).fail(function(c,b){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+b])}):c.storage.executeSql("DELETE FROM changed_values WHERE source_id=? and update_type=? and sent=1",
[c.id,a]).done(function(){d.resolve(a,[])}).fail(function(c,b){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+b])}):d.resolve(a,[])});d.when().done(function(){c.multipartItems=[];c.blobAttrs=[];b.resolve()}).fail(v(b))}g?(r.info("Push client changes to server. Source: "+c.name),r.trace("Push body: "+a.toJSON(j)),c.multipartItems.length>0?e():i.protocol.postData(j).done(function(){e()}).fail(function(a,d,e){c.engine.setState(i.states.stop);c.errCode=i.protocol.getErrCodeFromXHR(e);c.errCode=
h(d)?i.ERRORS.ERR_NOSERVERRESPONSE:c.errCode;c.error=d;b.reject(c.errCode,c.error)})):e()}var e=["create","update","delete"],f={};c.multipartItems=[];c.blobAttrs=[];var g=!1,j={source_name:c.name,client_id:c.engine.getClientId()},m=i.deferredMapOn(e);a.each(e,function(a,b){c.engine.isContinueSync()?(g=f[b]=!0,c.makePushBody_Ver3(b,!0).done(function(c){j[b]=c;m.resolve(a,[])}).fail(function(c,b){m.reject(a,[c,b])})):m.resolve(a,[])});m.when().done(function(){d()}).fail(v(b))}).promise()};this.makePushBody_Ver3=
function(c,b){var d=this;return a.Deferred(function(a){function e(){function h(e,g){if(g.rows&&g.rows.length&&0==g.rows.length)a.resolve(f);else{for(var j=0;j<g.rows.length;j++){var r=g.rows.item(j).attrib,m=g.rows.item(j).object,l=g.rows.item(j).value;g.rows.item(j);f[m]||(f[m]={});f[m][r]=l}b&&i.storage.executeSql("UPDATE changed_values SET sent=1 WHERE source_id=? and update_type=? and sent=0",[d.id,c]).done(function(){a.resolve(f)}).fail(q(a))}}i.storage.executeSql("SELECT attrib, object, value, attrib_type FROM changed_values where source_id=? and update_type =? and sent<=1 ORDER BY object",
[d.id,c]).done(function(a,c){h(a,c)}).fail(q(a))}var f={};b?m().done(function(){e()}).fail(q(a)):e()}).promise()};this.sync=function(){var c=this;return a.Deferred(function(a){function b(e,f){c.engine.stopSync();d();a.reject(e,f)}function d(){var a=Date.now();i.storage.executeSql("UPDATE sources set last_updated=?,last_inserted_size=?,last_deleted_size=?, last_sync_duration=?,last_sync_success=?, backend_refresh_time=? WHERE source_id=?",[a/1E3,c.getInsertedCount(),c.getDeletedCount(),a-e,c.getAtLeastOnePage?
1:0,c.refreshTime,c.id])}c.getNotify().reportSyncStatus("syncronizing"+c.name+"...",c.errCode,c.error);var e=Date.now();if(c.isTokenFromDb&&c.token>1)c.syncServerChanges().done(function(){d();a.resolve()}).fail(b);else{c.isEmptyToken()?c.processToken(1).done(function(){f()}).fail(b):f();var f=function(){c.syncClientChanges().done(function(e){e?(d(),a.resolve()):c.syncServerChanges().done(function(){d();a.resolve()}).fail(b)}).fail(b)}}}).promise()};this.getNotify=function(){return this.engine.getNotify()};
this.getInsertedCount=function(){return this.insertedCount};this.getDeletedCount=function(){return this.deletedCount}}function q(a){return function(c,b){a.reject(i.ERRORS.ERR_RUNTIME,"db access error: "+b)}}function v(a){return function(c,b){a.reject(c,b)}}function K(a){this.id=a;this.token=this.session=null;this.reset=this.token_sent=0;this.last_sync_success=this.port=null}var i=RhoConnect.rho,w={none:0,syncAllSources:1,syncSource:2,search:3,stop:4,exit:5},D={},x=[],V=new function(){var a={};this.setProperty=
function(c,b,d){var e=a[c];e||(e={},a[c]=e);e[b]=d||""};this.getProperty=function(c,b){var d=a[c];if(d)return d[b]||"";return""};this.getBoolProperty=function(a,c){var b=this.getProperty(a,c);return b=="1"||b=="true"}},N=null,y=w.none,O=!1,B=i.ERRORS.ERR_NONE,F="",G=!1,A=null,P=null,J=new i.Logger("SyncEngine"),H=!1;a.extend(i,{engine:function(){return{Client:K,Source:X,STATES:w,getSession:function(){return A},restoreSession:d,getSources:function(){return D},getSourcesArray:function(){return x},maxConfigSrcId:1,
login:g,logout:p,getState:R,setState:S,isSearch:n,doSyncAllSources:m,stopSync:E,getNotify:k,getSyncPageSize:function(){return 2E3},getClientId:function(){return P},getStartSourceId:T,findSourceBy:u,getSourceOptions:U,isNoThreadedMode:W,isSessionExist:L,isContinueSync:I,setSchemaChanged:function(a){G=a},isSchemaChanged:b,isStoppedByUser:function(){return H}}}()})})(jQuery);
(function(a){function k(a,b){this.params=a||"";this.removeAfterFire=b||!1;this.toString=function(){return"SyncNotification({removeAfterFire: "+this.removeAfterFire+"})"}}var n=RhoConnect.rho,b={none:0,"delete":1,update:2,create:3};a.extend(n,{notify:{ACTIONS:b,SyncNotify:function(d){function p(c){if(!m[c])return"";var b="";a.each(j,function(a,c){b+="&create_error[][object]="+a;b+="&create_error[][error_message]="+c});return b}function g(a){var b=null;d.isSearch()?b=f:(a!=null&&(b=u[a.id]),b==null&&
(b=C));if(b==null&&!d.isNoThreadedMode())return null;return b!=null?b:t}function e(a){if(d.isNoThreadedMode())return!1;return a&&"function"==typeof a.params?a.params():!0}var l=new n.Logger("SyncNotify"),j={},s="",h="",m={},f=null,u={},C=null,t=k(),o={};this.cleanCreateObjectErrors=function(){m={}};this.fireObjectsNotification=function(){var c="";a.each(j,function(d,e){a.each(e,function(a,f){if(f!=b.none)c&&(c+="&rho_callback=1&"),f==b["delete"]?(c+="deleted[][object]="+a,c+="&deleted[][source_id]="+
d):f==b.update?(c+="updated[][object]="+a,c+="&updated[][source_id]="+d):f==b.create&&(c+="created[][object]="+a,c+="&created[][source_id]="+d),e[a]=b.none})});c&&e(new k("",!1),c)};this.onObjectChanged=function(a,e,f){if(s){var g=d.getSources()[s];if(g){var m=h;if("string"==typeof g)s=g,h=m.match(/^\{/)?m.substring(1,m.length-2):m;else if(g="number"==typeof g?g:g.id){var l=j[g];l&&(l={},j[g]=l);l[m]=b.none}}h=s=""}(a=j[a])&&e in a&&(a[e]=f)};this.onSyncSourceEnd=function(a,b){var e=b[a];d.getState()==
d.STATES.stop&&e.errCode!=n.ERRORS.ERR_NONE?g(e)!=null?this.fireSyncNotification(e,!0,e.errCode,""):this.fireAllSyncNotifications(!0,e.errCode,e.error,""):this.fireSyncNotification(e,!0,e.errCode,"");this.cleanCreateObjectErrors()};this.reportSyncStatus=function(){};this.fireAllSyncNotifications=function(a,b,e,f){d.getState()!=d.STATES.exit&&(b!=n.ERRORS.ERR_NONE&&!d.isSearch()&&this.reportSyncStatus("sync_failed_forall.",b,e),g(null)&&this.doFireSyncNotification(null,a,b,e,"",f))};this.fireSyncNotification=
function(a,b,e,f){if(d.getState()!=d.STATES.exit){if((f||e!=n.ERRORS.ERR_NONE)&&!d.isSearch())a!=null&&!f&&(f="sync_failed_for"+a.name+"."),this.reportSyncStatus(f,e,a!=null?a.error:"");this.doFireSyncNotification(a,b,e,"","","")}};this.doFireSyncNotification=function(a,b,f,h,j,m){if(!d.isStoppedByUser())try{var s=null,k="",u=b;if(s=g(a)){k="";a&&(k+="total_count="+a.totalCount,k+="&processed_count="+a.curPageCount,k+="&processed_objects_count="+(o[a.id]||0),k+="&cumulative_count="+a.serverObjectsCount,
k+="&source_id="+a.id,k+="&source_name="+a.name);k+=(k?"&":"")+(j||"sync_type=incremental");k+="&status=";if(b){if(f==n.ERRORS.ERR_NONE)k+=!a&&!j?"complete":"ok";else{if(d.isStoppedByUser())f=n.ERRORS.ERR_CANCELBYUSER;k+="error";k+="&error_code="+f;h?k+="&error_message="+h:a&&(k+="&error_message="+a.error);m?k+="&"+m:a&&a.serverError&&(k+="&"+a.serverError)}a&&(k+=p(a.id))}else k+="in_progress";k+="&rho_callback=1";(u=u&&s.removeAfterFire)&&this.clearNotification(a);l.info("Fire notification. Source: "+
(a?a.name:"")+"; "+s.toString());e(s,k)&&this.clearNotification(a)}}catch(t){l.error("Fire notification failed.",t)}};this.setNotification=function(a,b){a&&this.setSyncNotification(a.id,b)};this.setSyncNotification=function(a,b){l.info("Set notification. Source ID: "+a+";"+(b?b.toString():""));a==-1?C=b:u[a]=b};this.clearNotification=function(a){l.info("Clear notification. Source: "+(a?a.name:""));d.isSearch()?f=null:u[a.id]=null};this.clearSyncNotification=function(a){l.info("Clear notification. Source ID: "+
a);a==-1?C=null:u[a]=null};this.cleanLastSyncObjectCount=function(){o={}};this.incLastSyncObjectCount=function(a){var b=o[a]||0;b+=1;return(o[a]=b)||0};this.callLoginCallback=function(a,b,f){d.isStoppedByUser()||(b="error_code="+b,b+="&error_message="+(f!=null?f:""),b+="&rho_callback=1",l.info("Login callback: "+a.toString()+". Body: "+b),e(a,b))}},SyncNotification:k,byEvent:function(b){a(window).trigger(jQuery.Event(b),a.makeArray(arguments).slice(1))}}});a.extend(RhoConnect,{SyncNotification:k})})(jQuery);
"undefined"!=typeof Ext&&function(a,k){var n=null;k.data.RhoconnectStorageProxy=k.extend(k.data.ClientProxy,{LOG:new RhoConnect.rho.Logger("Rhoconnect.plugin-extjs.js"),dbName:void 0,constructor:function(a){k.data.RhoconnectStorageProxy.superclass.constructor.call(this,a);this.setReader(this.reader);if(this.getStorageObject()==void 0)throw"Rhoconnect Storage is not available, please ensure you have rhoconnect.js scripts properly loaded";this.dbName=this.dbName||(this.store?this.store.storeId:void 0);
if(this.dbName==void 0)throw"No database name was provided to the rhoconnect storage proxy. See Ext.data.RhoconnectStorageProxy documentation for details";this.initialize()},create:function(b,d,p){function g(){b.setCompleted();typeof d=="function"&&d.call(p||this,b)}var e=this,l=b.records,j;b.setStarted();var k=RhoConnect.rho.deferredMapOn(l);a.each(l,function(a,b){b.phantom?(b.phantom=!1,j=e.getNextId()):j=b.getId();e.setRecord(b,j).done(function(b){k.resolve(a,[b])}).fail(function(b,d){k.reject(a,
[b,d])})});k.when().done(function(){b.setSuccessful();g()}).fail(function(){g();e.LOG.error("update() object update error")})},read:function(a,d,p){function g(){var g=null;e.root?(g={},g.name=l,g[e.root]=s,g=j.read(g)):g=j.read(s);k.apply(a,{resultSet:g});a.setCompleted();typeof d=="function"&&d.call(p||e,a)}var e=this,l=e.model.modelName,j=e.getReader(),s=[];a.id?e.getRecord(a.id).done(function(d){d&&(s.push(d),a.setSuccessful());g()}).fail(function(a,b){e.LOG.error("read() single object read error: "+
b);g()}):e.findAll(l).done(function(d){s=d;a.setSuccessful();g()}).fail(function(a,b){e.LOG.error("read() all objects read error: "+b);g()})},update:function(b,d,k){function g(){b.setCompleted();typeof d=="function"&&d.call(k||this,b)}var e=this,l=b.records;b.setStarted();var j=RhoConnect.rho.deferredMapOn(l);a.each(l,function(a,b){e.setRecord(b).done(function(b){j.resolve(a,[b])}).fail(function(b,d){j.reject(a,[b,d])})});j.when().done(function(){b.setSuccessful();g()}).fail(function(){g();e.LOG.error("update() object update error")})},
destroy:function(b,d,k){function g(){b.setCompleted();typeof d=="function"&&d.call(k||this,b)}var e=this,l=b.records;b.setStarted();var j=RhoConnect.rho.deferredMapOn(l);a.each(l,function(a,b){e.removeRecord(b).done(function(b){j.resolve(a,[b])}).fail(function(b,d){j.reject(a,[b,d])})});j.when().done(function(){b.setSuccessful();g()}).fail(function(){g();e.LOG.error("update() object update error")})},findAll:function(b){function d(a,b){var d={},g=k.model.prototype.fields.items,h=g.length,m,f,n;for(m=
0;m<h;m++)f=g[m],n=f.name,d[n]=typeof f.decode=="function"?f.decode(b[n]):b[n];d.id=a;return d}var k=this,g=k.getStorageObject();return a.Deferred(function(e){function l(a){g.executeSql("SELECT * FROM object_values WHERE source_id=?",[a]).done(function(a,b){for(var d={},e=0;e<b.rows.length;e++){var g=b.rows.item(e).object,k=b.rows.item(e).attrib,l=b.rows.item(e).value,c=d;c[g]||(c[g]={});c[g][k]=l}j(d)}).fail(function(a,b){k.LOG.error("findAll() select all objects for source error: "+b);e.reject(a,
b)})}function j(b){var g=[];a.each(b,function(a,b){g.push(d(a,b))});e.resolve(g)}g.executeSql("SELECT source_id FROM sources WHERE name=? LIMIT 1 OFFSET 0",[b]).done(function(a,b){var d=null;b.rows&&b.rows.length&&b.rows.length>0&&(d=b.rows.item(0).source_id);l(d)}).fail(function(a,b){k.LOG.error("findAll() source_id select error: "+b);e.reject(a,b)})}).promise()},getRecord:function(b){function d(a){var d={},g=k.model.prototype.fields.items,n=g.length,h,m,f={};for(h=0;h<a.rows.length;h++)m=a.rows.item(h).attrib,
f[m]=a.rows.item(h).value;for(h=0;h<n;h++)a=g[h],m=a.name,d[m]=typeof a.decode=="function"?a.decode(f[m]):f[m];d.id=b;return d}var k=this,g=k.getStorageObject();return a.Deferred(function(a){g.executeSql("SELECT * FROM object_values WHERE object=?",[b.toString()]).done(function(b,g){a.resolve(d(g))}).fail(function(b,d){k.LOG.error("getRecord() error: "+d);a.reject(b,d)})}).promise()},setRecord:function(b,d){var k=this,g=k.getStorageObject(),e=k.model.modelName,l=null,j=!1;d?(b.setId(d),j=!0):d=b.getId();
var n=b.data,h={},m=k.model.prototype.fields.items;return a.Deferred(function(f){function u(){g.executeSql("SELECT attrib FROM object_values WHERE object=?",[d.toString()]).done(function(a,b){for(var d=0;d<b.rows.length;d++){var e=b.rows.item(d).attrib;e&&(t[e]=!0)}C()}).fail(function(a,b){k.LOG.error("setRecord() read attr names error: "+b);f.reject(a,b)})}function C(){g.rwTx().ready(function(e,c){a.each(m,function(a,e){var f=e.name;h[f]=typeof e.encode=="function"?e.encode(n[f],b):n[f];var k=t[f]?
"UPDATE object_values SET value=? WHERE source_id=? and object=? and attrib=?":"INSERT INTO object_values ( value, source_id, object, attrib ) VALUES (?, ?, ?, ?)",m=h[f];f!="id"&&(g.executeSql(k,[m,l.toString(),d.toString(),f],c),j||g.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",[m,l.toString(),d.toString(),f,"update"],c))});j&&g.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",
[null,l.toString(),d.toString(),"object","create"],c)}).done(function(){b.dirty=!1;f.resolve(d)}).fail(function(){f.reject(null,"setRecord() update/insert attr error")})}if(void 0!=b.dirty&&!b.dirty)f.resolve(d);else{g.executeSql("SELECT source_id FROM sources WHERE name=?",[e]).done(function(a,b){b.rows&&b.rows.length&&b.rows.length>0&&(l=b.rows.item(0).source_id);u()}).fail(function(a,b){k.LOG.error("setRecord() read source_id error: "+b);f.reject(a,b)});var t={}}}).promise()},removeRecord:function(b){var d=
this,k=d.getStorageObject(),g=d.model.modelName,e=null,l=null;if(b&&b.data&&b.data.id)l=b.data.id;return a.Deferred(function(j){function n(){k.rwTx().ready(function(b,d){function f(){function b(){a.each(g,function(a,b){k.executeSql("INSERT INTO changed_values ( value, source_id, object, attrib, update_type ) VALUES (?, ?, ?, ?, ?)",[b,e.toString(),l.toString(),a,f],d)})}var f="delete";k.executeSql("SELECT update_type FROM changed_values WHERE object=? AND update_type=? AND sent=?",[l.toString(),"create",
0],d).done(function(d,c){0<c.rows.length&&(f=null);k.executeSql("DELETE FROM changed_values WHERE object=? AND source_id=? AND sent=?",[l.toString(),e.toString(),0],d).done(function(){var c=!1;a.each(g,function(){f&&(c=!0)});c&&b()})})}var g={};k.executeSql("SELECT * FROM object_values WHERE object=? AND source_id=?",[l.toString(),e.toString()],d).done(function(a,b){for(var d=0;d<b.rows.length;d++){var c=b.rows.item(d).attrib,h=b.rows.item(d).value;c&&(g[c]=h)}k.executeSql("DELETE FROM object_values WHERE object=? AND source_id=?",
[l.toString(),e.toString()],a).done(function(){f()})})}).done(function(){b.dirty=!1;j.resolve(l)}).fail(function(){j.reject(null,"setRecord() remove attr error")})}k.executeSql("SELECT source_id FROM sources WHERE name=?",[g]).done(function(a,b){b.rows&&b.rows.length&&b.rows.length>0&&(e=b.rows.item(0).source_id);n()}).fail(function(a,b){d.LOG.error("setRecord() read source_id error: "+b);j.reject(a,b)})}).promise()},initialize:function(){},clear:k.emptyFn,getStorageObject:function(){return RhoConnect.rho.storage},
getNextId:function(){n=n||Date.now()-(new Date(2009,1,1)).getTime();n+=1;return n}});k.data.ProxyMgr.registerType("rhoconnect",k.data.RhoconnectStorageProxy)}(jQuery,Ext);
