var RhoSync=function(a){function h(b,k){return a.Deferred(function(j){g.storage.loadAllSources(b).done(function(b,q){var l=g.engine.getStartSourceId(q),p={};a.each(q,function(a,e){p[e.name]=e});var s={},o=[];a.each(k,function(p){var e=new a.Deferred;s[p]=e;o.push(e.promise())});a.each(k,function(a,e){var c=p[e.name];if(c){var f=!1;if(c.sync_priority!=e.sync_priority)c.sync_priority=e.sync_priority,f=!0;if(c.sync_type!=e.sync_type)c.sync_type=e.sync_type,f=!0;if(c.associations!=e.associations)c.associations=
e.associations,f=!0;if(!e.id)e.id=c.id;f&&g.storage.storeSource(c,b).done(function(c,e){s[a].resolve(e)}).fail(function(c,e){s[a].reject(c,e)})}else{if(!e.id)e.id=l,l=1;g.storage.insertSource(e,b).done(function(c,e){s[a].resolve(e)}).fail(function(c,e){s[a].reject(c,e)})}});a.when(o).done(function(){j.resolve()}).fail(function(a,e){j.reject(a,e)})}).fail(function(a,q){j.reject(a,q)})}).promise()}function m(b){return a.Deferred(function(k){a.each(b,function(a,b){b.associations=""});a.each(b,function(j,
g){g&&g.model&&g.model.belongsTo&&a.each(g.model.belongsTo,function(a,j){var p=b[j];if(p){var s=p.associations||"";s+=0<s.length?", ":"";s+=g.name+", "+a;p.associations=s}})});g.storage.open().done(function(a){g.storage.rwTx(a).ready(function(a,q){h(q,b).done(function(){k.resolve()}).fail(function(a,p){k.reject(a,p)})}).fail(function(a,b){k.reject(a,b)})})}).promise()}function d(l,k,j){function d(a){if(a&&!a.isLoaded&&(a.isLoaded=!0,"string"==typeof a.name)){var j=new g.domain.Model(a);j.source.sync_priority=
parseInt(a.sync_priority||1E3);j.source.sync_type="incremental";j.source.partition="user";var p=a.source_id?parseInt(a.source_id):null;if((j.source.id=p)&&g.engine.maxConfigSrcId<p)g.engine.maxConfigSrcId=p;b[a.name]=j;g.engine.getSources()[a.name]=j.source}}if(t)return a.Deferred().resolve().promise();k&&"object"==typeof k&&(a.isArray(k)?a.each(k,function(a,b){d(b)}):d(k));t=!0;return m(g.engine.getSources()).done(function(){a.each(g.engine.getSources(),function(a,b){g.engine.getNotify().setNotification(b,
new g.notify.SyncNotification(function(){if("function"==typeof j)return j(a),!1},!1))})})}var b={},t=!1,g={config:a.extend({},{syncServer:"",consoleServer:"",pollInterval:20,database:{namePrefix:"rhoSyncDb_",name:"UNINITIALIZED",version:"1.0",comment:"RhoSync database",size:2097152}},RhoConfig),EVENTS:{GENERIC_NOTIFICATION:"rhoSyncGenericNotification",ERROR:"rhoSyncError",CLIENT_CREATED:"rhoSyncClientCreated",STATUS_CHANGED:"rhoSyncStatusChanged",SYNCHRONIZING:"rhoSyncSourceSynchronizing",SYNC_SOURCE_END:"rhoSyncSourceSynchronizationEnd"},
getModels:function(){return b},domain:null,protocol:null,engine:null,notify:null,storage:null};return a.extend({ERRORS:{ERR_NONE:"No error",ERR_NETWORK:"Network error",ERR_REMOTESERVER:"Remote server access error",ERR_RUNTIME:"Runtime error",ERR_UNEXPECTEDSERVERRESPONSE:"Unexpected server response",ERR_DIFFDOMAINSINSYNCSRC:"Different synchronization domain error",ERR_NOSERVERRESPONSE:"No server response",ERR_CLIENTISNOTLOGGEDIN:"Client not logged in",ERR_CUSTOMSYNCSERVER:"Custom sync server",ERR_UNATHORIZED:"Unauthorized access",
ERR_CANCELBYUSER:"Canceled by user",ERR_SYNCVERSION:"Synchronization version error",ERR_GEOLOCATION:"Geolocation error"},init:function(l,k,j,z){return a.Deferred(function(a){g.storage.init(z).done(function(){g.engine.restoreSession().done(function(){b={};t=!1;d(k,l,j).done(function(){a.resolve()}).fail(function(b,p){a.reject("models load error: "+p)})}).fail(function(b,p){a.reject("session restoring error: "+p)})}).fail(function(b){a.reject("storage initialization error: "+b)})}).promise()},login:function(b,
d,j){return a.Deferred(function(a){g.engine.login(b,d,j).done(function(){a.resolve()}).fail(function(b,j){a.reject(b,j)})}).promise()},logout:function(){return g.engine.logout()},isLoggedIn:function(){return g.engine.isSessionExist()},syncAllSources:function(){return g.engine.doSyncAllSources()}},{rho:g})}(jQuery);
(function(a){function h(a){function b(a){window.console&&a(window.console)}function h(b,g){return Date().replace(/\S+\s(.*?)\sGMT\+.*$/,"$1")+" ["+l[b]+"] ("+a+") "+g}var g={trace:0,info:1,warning:2,error:3,fatal:4},l=["Trace","Info","Warning","Error","Fatal"],k="string"==typeof m.config.logLevel&&m.config.logLevel.toLowerCase()in g?g[m.config.logLevel.toLowerCase()]:g.warning;this.trace=function(a){var d=g.trace;k>d||b(function(b){b.info(h(d,a))})};this.info=function(a){var d=g.info;k>d||b(function(b){b.info(h(d,
a))})};this.warning=function(a,d){var l=g.warning;k>l||b(function(b){b.warn(h(l,a));d&&b.warn("EXCEPTION: "+d)})};this.error=function(a,d){var l=g.error;k>l||b(function(b){b.error(h(l,a));d&&b.error("EXCEPTION: "+d)})};this.fatal=function(a,d){var l=g.fatal;k>l||b(function(b){b.error(h(l,a));d&&b.error("EXCEPTION: "+d)})}}var m=RhoSync.rho;a.extend(m,{Logger:h,ERRORS:RhoSync.ERRORS,deferredMapOn:function(d){var b={},h=[];a.each(d,function(d){var l=new a.Deferred;b[d]=l;h.push(l.promise())});return{resolve:function(a,
d){b[a]&&b[a].resolve.apply(b[a],d)},reject:function(a,d){b[a]&&b[a].reject.apply(b[a],d)},when:function(){return a.when.apply(this,h)}}},passRejectTo:function(a){return function(){a.reject(arguments)}}});a.extend(RhoSync,{Logger:h})})(jQuery);
(function(a){function h(a){for(var b=document.cookie.split(";"),d=0;d<b.length;d++){var g=b[d].split("=");if(g[0].replace(/^\s+|\s+$/g,"")==a)return 1<g.length?g[1].replace(/^\s+|\s+$/g,""):""}return null}function m(l,k,j,h){return a.Deferred(function(m){var t=(/\?/.test(l)?"&":"?")+b+"="+g;a.ajax({url:l+(g?t:""),type:j||"post",contentType:h||"application/json",processData:!1,data:a.toJSON(k),dataType:"json",headers:{"X-Origin":function(){var a=document.location;return a.href.substring(0,a.href.length-
a.pathname.length)}()},xhrFields:{withCredentials:!0}}).done(function(a,b,o){d.notify.byEvent(d.EVENTS.GENERIC_NOTIFICATION,b,a,o);m.resolve(b,a,o)}).fail(function(a,b,o){d.notify.byEvent(d.EVENTS.GENERIC_NOTIFICATION,b,o,a);m.reject(b,o,a)})}).promise()}var d=RhoSync.rho,b="rhosync_session",t={HTTP_OK:200,HTTP_PARTIAL_CONTENT:206,HTTP_MOVED_TEMPORARILY:302,HTTP_MOVED_PERMANENTLY:301,HTTP_MOVED_PERM:301,HTTP_BAD_REQUEST:400,HTTP_NOT_FOUND:404,HTTP_UNAUTHORIZED:401,HTTP_RANGENOTSATISFY:416,HTTP_INTERNAL_ERROR:500,
HTTP_NOTMODIFIED:304},g=null;a.extend(d,{protocol:{getVersion:function(){return 3},getErrCodeFromXHR:function(a){switch(a.status){case t.HTTP_UNAUTHORIZED:return d.ERRORS.ERR_UNATHORIZED;case t.HTTP_OK:return d.ERRORS.ERR_NONE;case t.HTTP_PARTIAL_CONTENT:return d.ERRORS.ERR_NONE;default:return d.ERRORS.ERR_REMOTESERVER}},getSession:function(){return h(b)},setSession:function(){},deleteSession:function(){var a=b,d=window.location.hostname;if(h(a))document.cookie=a+"=; path=/"+(d?"; domain="+d:"")+
"; expires=Thu, 01-Jan-1970 00:00:01 GMT"},getServerQueryUrl:function(){return d.config.syncServer},login:function(l,k){return a.Deferred(function(a){m(d.config.syncServer+"/clientlogin",{login:l,password:k,rememberme:1}).done(function(d,l,k){l&&(g=l[b]||null);a.resolve(l,d,k)}).fail(function(b,d,g){a.reject(b,d,g)})}).promise()},logout:function(){g=null},clientCreate:function(){return m(d.config.syncServer+"/clientcreate","","get","text/plain")},clientReset:function(a){return m(d.config.syncServer+
"/clientreset",{client_id:a},"get","text/plain")},serverQuery:function(a,b,g,h){b="?version=3&client_id="+b+"&p_size="+g;b+=a?"&source_name="+a:"";b+=h?"&token="+h:"";return m(d.config.syncServer+b,"","get","text/plain")},postData:function(a){return m(d.config.syncServer+"",a)}}})})(jQuery);
(function(a){function h(a){this.id=null;this.fields=a.fields;this.values={};var b=!0;this.__defineGetter__("isNew",function(){return b});var h=!1;this.__defineGetter__("isChanged",function(){return h});var g=function(a,b){this.values[a]=b;h=!0};this.addField=function(a){this.__defineGetter__(a,function(){return this.values[a]});this.__defineSetter__(a,function(b){g(a,b)})};this.deleteField=function(a){this.__defineGetter__(a,void 0);this.__defineSetter__(a,void 0);delete this.fields[a];delete this.values[a]};
this.clearNotifications=function(){};this.destroy=function(){};this.updateAttributes=function(){this.save()};this.save=function(){h=b=!1}}var m=RhoSync.rho;a.extend(m,{domain:{SyncObject:h,Model:function(a){this.source=new m.engine.Source(a.sourceId,a.name,"incremental",m.storage,m.engine,this);this.__defineGetter__("name",function(){return this.source.name});this.__defineSetter__("name",function(a){this.source.name=a});this.belongsTo=a.belongsTo;this.deleteAll=function(){};this.find=function(){};
this.findAll=function(){};this.findBySql=function(){};this.newObject=function(a){return new h(a)};this.createObject=function(a){a=this.newObject(a);a.save();return a};this.paginate=function(){};this.sync=function(){};this.setNotification=function(){};this.save=function(){};this.canModify=function(){}}}})})(jQuery);
(function(a){function h(b,d,o,v){return a.Deferred(function(a){var c=b||j.config.database.name,f=d||j.config.database.version,g=o||j.config.database.comment,h=v||j.config.database.size,D;q[c]||(q[c]={});q[c][f]||(q[c][f]=null);if(D=q[c][f])a.resolve(D);else try{var k=openDatabase(c,f,g,h);q[c]||(q[c]={});D=q[c][f]=k;a.resolve(D)}catch(l){a.reject(l)}}).promise()}function m(b,d){function o(a){var f="function"==typeof a.readTransaction?a.readTransaction:a.transaction;if(b&&b!="read-only")f=a.transaction;
try{f.apply(a,[function(e){v.resolve(a,e)},function(b){e.reject(a,b)},function(){e.resolve(a,"ok")}])}catch(d){e.reject(a,d.message)}}var v=a._Deferred(),e=a.Deferred();d?o(d):h().done(function(a){o(a)}).fail(function(a){e.reject(null,a)});e.promise();e.ready=v.done;return e}function d(b,d,o){return a.Deferred(function(a){function e(c,e,b){c.executeSql(e,b,function(c,e){a.resolve(c,e)},function(c,e){a.reject(c,e)})}if(o)e(o,b,d);else{var c=!b.match(/^\s*select\s+/i);m(c).ready(function(a,c){e(c,b,
d)}).done(function(c,e){a.resolve(c,e)}).fail(function(c,e){a.reject(c,e)})}}).promise()}function b(b,g){function o(a,b){var f=e[c];if(0<b.length){var p=b.shift();d(p,null,a).done(function(a,e){f.resolve(a,e,p);c++;o(a,b)}).fail(function(a,c){f.reject(a,c)})}}var v=b.replace(/^\s+|;\s*$/,"").split(";"),e=[],c=0,f=a.Deferred();e.push(f);c++;a.each(v,function(){e.push(a.Deferred())});g?o(g,v):m("read-write").ready(function(a,c){o(c,v)}).done(function(a,c){f.resolve(a,c)}).fail(function(a,c){f.reject(a,
c)});var h=[];a.each(e,function(a,c){h.push(c.promise())});return a.when.apply(this,h)}function t(){return b(z)}function g(b){return a.Deferred(function(a){d("SELECT name FROM sqlite_master WHERE type='table'",null,b).done(function(b,p){for(var e=[],c=0;c<p.rows.length;c++)e.push(p.rows.item(c).name);a.resolve(b,e)}).fail(function(b,p){a.reject(b,p)})}).promise()}function l(b,g,o){return a.Deferred(function(a){d(o?"INSERT INTO client_info ( session, token, token_sent, reset, port, last_sync_success, client_id ) VALUES (?, ?, ?, ?, ?, ?, ?)":
"UPDATE client_info SET session = ?, token = ?, token_sent = ?, reset = ?, port = ?, last_sync_success = ? WHERE client_id = ?",[b.session,b.token,b.token_sent,b.reset,b.port,b.last_sync_success,b.id],g).done(function(e){a.resolve(e,b)}).fail(function(b,c){a.reject(b,c)})}).promise()}function k(b,g,o){return a.Deferred(function(a){d(o?"INSERT INTO sources ( name, token, sync_priority, partition, sync_type, metadata, last_updated, last_inserted_size, last_deleted_size, last_sync_duration, last_sync_success, backend_refresh_time, source_attribs, schema, schema_version, associations, blob_attribs, source_id ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)":
"UPDATE sources SET name = ?, token = ?, sync_priority = ?, partition = ?, sync_type = ?, metadata = ?, last_updated = ?, last_inserted_size = ?, last_deleted_size = ?, last_sync_duration = ?, last_sync_success = ?, backend_refresh_time = ?, source_attribs = ?, schema = ?, schema_version = ?, associations = ?, blob_attribs = ? WHERE source_id = ?",[b.name,b.token,b.sync_priority,b.partition,b.sync_type,b.metadata,b.last_updated,b.last_inserted_size,b.last_deleted_size,b.last_sync_duration,b.last_sync_success,
b.backend_refresh_time,b.source_attribs,b.schema,b.schema_version,b.associations,b.blob_attribs,b.id],g).done(function(e){a.resolve(e,b)}).fail(function(b,c){a.reject(b,c)})}).promise()}var j=RhoSync.rho,z='DROP TABLE IF EXISTS client_info;CREATE TABLE client_info ( "client_id" VARCHAR(255) default NULL, "session" VARCHAR(255) default NULL, "token" VARCHAR(255) default NULL, "token_sent" BIGINT default 0, "reset" BIGINT default 0, "port" VARCHAR(10) default NULL, "last_sync_success" VARCHAR(100) default NULL);DROP TABLE IF EXISTS object_values;CREATE TABLE object_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL);DROP TABLE IF EXISTS changed_values;CREATE TABLE changed_values ( "source_id" BIGINT default NULL, "attrib" varchar(255) default NULL, "object" varchar(255) default NULL, "value" varchar default NULL, "attrib_type" varchar(255) default NULL, "update_type" varchar(255) default NULL, "sent" BIGINT default 0);DROP TABLE IF EXISTS sources;CREATE TABLE sources ( "source_id" BIGINT PRIMARY KEY, "name" VARCHAR(255) default NULL, "token" BIGINT default NULL, "sync_priority" BIGINT, "partition" VARCHAR(255), "sync_type" VARCHAR(255), "metadata" varchar default NULL, "last_updated" BIGINT default 0, "last_inserted_size" BIGINT default 0, "last_deleted_size" BIGINT default 0, "last_sync_duration" BIGINT default 0, "last_sync_success" BIGINT default 0, "backend_refresh_time" BIGINT default 0, "source_attribs" varchar default NULL, "schema" varchar default NULL, "schema_version" varchar default NULL, "associations" varchar default NULL, "blob_attribs" varchar default NULL);DROP INDEX IF EXISTS by_src_id;CREATE INDEX by_src_id on object_values ("source_id");DROP INDEX IF EXISTS by_src_object;CREATE UNIQUE INDEX by_src_object ON object_values ("object", "attrib", "source_id");DROP INDEX IF EXISTS by_src_value;CREATE INDEX by_src_value ON object_values ("attrib", "source_id", "value");',
q={},C=new function(){this.blobAttrs={};this.srcNames={};this.initAttrManager=function(){return this.loadAttrs()};this.isBlobAttr=function(a,b){var d=this.blobAttrs[a];return d?b in d:!1};this.loadAttrs=function(){var b=this;return a.Deferred(function(d){b.blobAttrs={};var g="SELECT source_id,";g+="blob_attribs,name from sources";j.storage.executeSql(g).done(function(v,e){for(var c=0;c<e.rows.length;c++){var f=e.rows.item(0).source_id,g=e.rows.item(0).blob_attribs;if(!g)return;var o=new {},h="";a.each(g.split(","),
function(a,c){c&&(h?(o[h]=+c,h=""):h=c)});b.blobAttrs[f]=o;b.srcNames!=null&&(b.srcNames[e.rows.item(c).name.toUpperCase()]=f)}d.resolve()}).fail(function(a,b){d.reject(a,b)})}).promise()}};a.extend(j,{storage:{attrManager:C,listClientsId:function(b){return a.Deferred(function(a){d("SELECT client_id FROM client_info",null,b).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++)e.push(d.rows.item(c).client_id);a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadClient:function(b,
g){return a.Deferred(function(a){d("SELECT * FROM client_info WHERE client_id = ?",[b],g).done(function(d,e){if(0==e.rows.length)a.reject(b,"Not found");else{var c=new j.engine.Client(b);c.session=e.rows.item(0).session;c.token=e.rows.item(0).token;c.token_sent=e.rows.item(0).token_sent;c.reset=e.rows.item(0).reset;c.port=e.rows.item(0).port;c.last_sync_success=e.rows.item(0).last_sync_success;a.resolve(d,c)}}).fail(function(b,e){a.reject(b,e)})}).promise()},loadAllClients:function(b){return a.Deferred(function(a){d("SELECT * FROM client_info",
null,b).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++){var f=new j.engine.Client(d.rows.item(c).client_id);f.session=d.rows.item(c).session;f.token=d.rows.item(c).token;f.token_sent=d.rows.item(c).token_sent;f.reset=d.rows.item(c).reset;f.port=d.rows.item(c).port;f.last_sync_success=d.rows.item(c).last_sync_success;e.push(f)}a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeClient:l,insertClient:function(a,b){return l(a,b,!0)},deleteClient:function(b,g){var h="object"==
typeof b?b.id:b;return a.Deferred(function(a){d("DELETE FROM client_info WHERE client_id = ?",[h],g).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},listSourcesId:function(b){return a.Deferred(function(a){d("SELECT source_id FROM sources",null,b).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++)e.push(d.rows.item(c).source_id);a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},loadSource:function(b,g){return a.Deferred(function(a){d("SELECT * FROM sources WHERE source_id = ?",
[b],g).done(function(d,e){if(0==e.rows.length)a.reject(b,"Not found");else{var c=new j.engine.Source(e.rows.item(0).source_id,e.rows.item(0).name,e.rows.item(0).sync_type,j.storage,j.engine);c.token=e.rows.item(0).token;c.sync_priority=e.rows.item(0).sync_priority;c.partition=e.rows.item(0).partition;c.sync_type=e.rows.item(0).sync_type;c.metadata=e.rows.item(0).metadata;c.last_updated=e.rows.item(0).last_updated;c.last_inserted_size=e.rows.item(0).last_inserted_size;c.last_deleted_size=e.rows.item(0).last_deleted_size;
c.last_sync_duration=e.rows.item(0).last_sync_duration;c.last_sync_success=e.rows.item(0).last_sync_success;c.backend_refresh_time=e.rows.item(0).backend_refresh_time;c.source_attribs=e.rows.item(0).source_attribs;c.schema=e.rows.item(0).schema;c.schema_version=e.rows.item(0).schema_version;c.associations=e.rows.item(0).associations;c.blob_attribs=e.rows.item(0).blob_attribs;c.parseAssociations();a.resolve(d,c)}}).fail(function(b,e){a.reject(b,e)})}).promise()},loadAllSources:function(b){return a.Deferred(function(a){d("SELECT * FROM sources ORDER BY sync_priority",
null,b).done(function(b,d){for(var e=[],c=0;c<d.rows.length;c++){var f=new j.engine.Source(d.rows.item(c).source_id,d.rows.item(c).name,d.rows.item(c).sync_type,j.storage,j.engine);f.token=d.rows.item(c).token;f.sync_priority=d.rows.item(c).sync_priority;f.partition=d.rows.item(c).partition;f.sync_type=d.rows.item(c).sync_type;f.metadata=d.rows.item(c).metadata;f.last_updated=d.rows.item(c).last_updated;f.last_inserted_size=d.rows.item(c).last_inserted_size;f.last_deleted_size=d.rows.item(c).last_deleted_size;
f.last_sync_duration=d.rows.item(c).last_sync_duration;f.last_sync_success=d.rows.item(c).last_sync_success;f.backend_refresh_time=d.rows.item(c).backend_refresh_time;f.source_attribs=d.rows.item(c).source_attribs;f.schema=d.rows.item(c).schema;f.schema_version=d.rows.item(c).schema_version;f.associations=d.rows.item(c).associations;f.blob_attribs=d.rows.item(c).blob_attribs;f.parseAssociations();e.push(f)}a.resolve(b,e)}).fail(function(b,d){a.reject(b,d)})}).promise()},storeSource:k,insertSource:function(a,
b){return k(a,b,!0)},deleteSource:function(b,g){var h="object"==typeof b?b.id:b;return a.Deferred(function(a){d("DELETE FROM sources WHERE source_id = ?",[h],g).done(function(b){a.resolve(b,null)}).fail(function(b,c){a.reject(b,c)})}).promise()},init:function(b){return a.Deferred(function(a){g().done(function(d,g){(5!=g.length||b)&&t().done(function(){a.resolve(null,"db schema initialized")}).fail(function(b,c){a.reject(b,"db schema initialization error: "+c)});a.resolve(null,"db schema is ok")}).fail(function(b,
d){a.reject(b,"db tables read error: "+d)})}).promise()},open:h,tx:m,roTx:function(a){return m(!1,a)},rwTx:function(a){return m("read-write",a)},executeSql:d,executeBatchSql:b,initSchema:t,getAllTableNames:g}})})(jQuery);
(function(a){function h(){return P=P||new i.notify.SyncNotify(i.engine)}function m(){return Q}function d(){return H}function b(){return a.Deferred(function(a){A="";i.storage.executeSql("SELECT session FROM client_info").done(function(b,c){for(var d=0;d<c.rows.length;d++){var e=c.rows.item(d).session;if(e){A=e;break}}a.resolve()}).fail(n(a))}).promise()}function t(){return a.Deferred(function(a){i.storage.executeSql("UPDATE client_info SET session = NULL").done(function(){A="";i.protocol.logout();
a.resolve()}).fail(n(a))}).promise()}function g(b,c,d){return a.Deferred(function(a){I=!1;i.protocol.login(b,c).done(function(){A=b;i.config.database.name=i.config.database.namePrefix+b;A||K.error("Server responds with empty session cookie.");i.storage.init().done(function(){if(A)I?a.reject(i.ERRORS.ERR_CANCELBYUSER,"Stopped by user"):l(b).done(function(){i.config.rho_sync_user=name;h().callLoginCallback(d,i.ERRORS.ERR_NONE,"");a.resolve()}).fail(u(a));else{K.error("DB doesn't contains this session.");
var c=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;h().callLoginCallback(d,c,"");a.reject(c,"")}}).fail(u(a))}).fail(function(b,c,e){b=i.protocol.getErrCodeFromXHR(e);if(q(c))b=i.ERRORS.ERR_NOSERVERRESPONSE;b!=i.ERRORS.ERR_NONE&&h().callLoginCallback(d,b,e.responseText);a.reject(b,c)})}).promise()}function l(b){return a.Deferred(function(a){i.storage.loadAllClients().done(function(c){if(0<c.length)i.storage.executeSql("UPDATE client_info SET session=?",[b]).done(function(){a.resolve(c[0])}).fail(n(a));else{var d=
new L(null);d.session=b;i.storage.insertClient(d).done(function(b,c){a.resolve(c)}).fail(n(a))}}).fail(n(a))}).promise()}function k(b){return a.Deferred(function(a){i.storage.loadAllClients().done(function(c,d){if(0<d.length)i.storage.executeSql("UPDATE client_info SET client_id=?",[b]).done(function(){a.resolve(b)}).fail(n(a));else{var e=new L(null);e.id=b;i.storage.insertClient(e).done(function(){a.resolve(b)}).fail(n(a))}}).fail(n(a))}).promise()}function j(){return a.Deferred(function(a){i.protocol.clientCreate().done(function(b,
c){c&&c.client&&c.client.client_id?k(c.client.client_id).done(function(b){a.resolve(b)}).fail(u(a)):a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,c)}).fail(function(b,c){var d=q(c)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;a.reject(d,c)})}).promise()}function z(b){return a.Deferred(function(a){i.protocol.clientReset(b).done(function(b,c){c&&c.sources?a.resolve():a.reject(i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE,c)}).fail(function(b,c){var d=q(c)?i.ERRORS.ERR_NOSERVERRESPONSE:i.ERRORS.ERR_NETWORK;
a.reject(d,c)})}).promise()}function q(a){return a&&a.match(/time(d)?\s+out/i)}function C(){return a.Deferred(function(a){p(w.syncAllSources,null).done(function(){J()?f().done(function(){if(y!=w.exit)y=w.none;h().cleanCreateObjectErrors();a.resolve()}).fail(function(b,c){if(y!=w.exit)y=w.none;i.notify.byEvent(i.EVENTS.ERROR,"Sync failed",c);a.reject(b,c)}):(h().cleanCreateObjectErrors(),a.resolve())}).fail(function(b,c){a.reject(b,c)})}).promise()}function p(b,c){return a.Deferred(function(a){y=b;
Q=b==w.search;I=!1;B=i.ERRORS.ERR_NONE;F="";H=!1;e().done(function(){o().done(function(b){function d(){var a=null;c&&(a=s("id",c));a?(a.errCode=B,a.error=F,h().fireSyncNotification(a,!0,a.errCode,"")):h().fireAllSyncNotifications(!0,B,F,"")}A=b;M()?v().done(function(b){R=b;B==i.ERRORS.ERR_NONE?(h().cleanLastSyncObjectCount(),a.resolve()):(d(),r(),a.reject(B,F))}).fail(u(a)):(B=i.ERRORS.ERR_CLIENTISNOTLOGGEDIN,d(),r(),a.reject(B,F))}).fail(u(a))}).fail(u(a))}).promise()}function s(a,b){for(var c=0;c<
x.length;c++)if(x[c][a]==b)return x[c];return null}function o(){return a.Deferred(function(a){i.storage.loadAllClients().done(function(b,c){for(var d=null,e=0;e<c.length;e++)if(c[e].session){d=c[e].session;break}a.resolve(d)}).fail(n(a))}).promise()}function v(){return a.Deferred(function(a){var b="",c=!1;i.storage.loadAllClients().done(function(d,e){var f=null;if(0<e.length)f=e[0],b=f.id,c=f.reset;b?c?z(b).done(function(b){f.reset=0;i.storage.storeClient(f).done(function(){a.resolve(b)}).fail(function(b,
c){r();n(a)(b,c)})}).fail(function(b,c){r();a.reject(b,c)}):a.resolve(b):j().done(function(b){a.resolve(b)}).fail(u(a))}).fail(n(a))}).promise()}function e(){return a.Deferred(function(b){E={};i.storage.loadAllSources().done(function(d,e){a.each(e,function(a,b){if(b.sync_type!="none")b.storage=i.storage,b.engine=i.engine,E[b.name]=b});c();b.resolve()}).fail(n(b))}).promise()}function c(){function b(a,c,d){if(c>=a.length)return a.concat(d);c<0&&(c=0);return a.slice(0,c).concat(d,a.slice(c))}function c(a,
b){for(var d=0;d<a.length;d++)if(b==a[d].name)return d;return-1}var d={},e=[];a.each(E,function(a,b){e.push(b)});e.sort(function(a,b){if(a.sync_priority<b.sync_priority)return-1;if(a.sync_priority>b.sync_priority)return 1;return 0});for(var i=e.length-1;i>0;){var f=e[i];if(f.getAssociations().length==0||f.name in d)i--;else for(var g=i,h=0;h<f.getAssociations().length;h++){var j=f.getAssociations()[h],j=c(e,j.m_strSrcName);j>=0&&j<g&&(e.splice(g,1),b(e,j,f),g=j)}d[f.name]=!0}E={};a.each(e,function(a,
b){E[b.name]=b});x=e}function f(){return a.Deferred(function(b){var c=!1,d={};a.each(x,function(a,b){d[b.name]=b});var e=i.deferredMapOn(a.extend({},d,{rhoStartSyncSource:"noMatterValue_itUseJustKeys"})),f=[],g=S(),j=0<=g?x[g]:null;0<=g?O(g).done(function(){e.resolve("rhoStartSyncSource",["ok"])}).fail(function(a,b){c=!0;f.push({source:j.name,errCode:a,error:b});e.resolve("rhoStartSyncSource",["error",a,b])}):e.resolve("rhoStartSyncSource",["ok"]);a.each(x,function(a,b){O(a).done(function(){e.resolve(b.name,
["ok"])}).fail(function(a,d){c=!0;f.push({source:b.name,errCode:a,error:d});e.resolve(b.name,["error",a,d])})});e.when().done(function(){!c&&!H?(h().fireSyncNotification(null,!0,i.ERRORS.ERR_NONE,"sync_completed"),b.resolve(i.ERRORS.NONE,"Sync completed")):b.reject('Error for source"'+f[0].source+'": '+(f[0].error||f[0].errCode))}).fail(function(){K.error("Implementation error in SyncEngine.syncAllSources: some source has been rejected!");b.reject(f)})}).promise()}function S(){for(var a=0;a<x.length;a++)if(!x[a].isEmptyToken())return a;
return-1}function O(b){return a.Deferred(function(a){var c=x[b];if(c.sync_type=="bulk_sync_only")a.resolve(null);else if(M()&&y!=w.stop){c.sync().done(function(){a.resolve(c)}).fail(function(b,d){if(c.errCode==i.ERRORS.ERR_NONE)c.errCode=i.ERRORS.ERR_RUNTIME;y=w.stop;a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped: "+d)}).then(d,d);var d=function(){h().onSyncSourceEnd(b,x)}}else a.reject(i.ERRORS.ERR_RUNTIME,"sync is stopped")}).promise()}function D(){return y}function T(a){y=a}function J(){var a=
y;return a!=w.exit&&a!=w.stop}function r(){if(J())y=w.stop}function U(b){var c=0;a.each(b,function(a,b){c=b.id>c?b.id:c});c<i.engine.maxConfigSrcId?c=i.engine.maxConfigSrcId+2:c+=1;return c}function V(){return W}function X(){return!1}function M(){return A?!0:!1}function Y(b,c,d,e,f){function g(a,b){this.m_strSrcName=a;this.m_strAttrib=b}function h(a,b){this.m_strAttrib=a;this.m_strValue=b;this.m_strBlobSuffix="";if("string"==typeof this.m_strAttrib&&this.m_strAttrib.match(/\-rhoblob$/))this.m_strBlobSuffix=
"-rhoblob",this.m_strAttrib=this.m_strAttrib.substring(0,this.m_strAttrib.length-this.m_strBlobSuffix.length)}function j(){return a.Deferred(function(b){function c(d,e){for(var f=[],g=[],G=[],h=0;h<e.rows.length;h++)f.push(e.rows.item(h).object),G.push(e.rows.item(h).source_id),g.push(e.rows.item(h).update_type);var j=i.deferredMapOn(f);a.each(f,function(a,c){i.storage.executeSql("SELECT name, schema FROM sources WHERE source_id=?",[G[a]],d).done(function(d,e){var f=!1,h="object_values";if(e.rows.length>
0)(f=e.rows.item(0).schema)&&(h=e.rows.item(0).name);if(f)j.resolve(a,[]);else{i.storage.executeSql("SELECT attrib, value FROM "+h+" where object=? and source_id=?",[c,G[a]],d).done(function(a,b){N(a,b)}).fail(n(b));var N=function(d,e){for(var f=0;f<e.rows.length;f++){var h=e.rows.item(f).attrib,N=e.rows.item(f).value,Z=i.storage.attrManager.isBlobAttr(G[a],h)?"blob.file":"";i.storage.executeSql("INSERT INTO changed_values (source_id,object,attrib,value,update_type,attrib_type,sent) VALUES(?,?,?,?,?,?,?)",
[G[a],c,h,N,g[a],Z,0],d).done(function(){}).fail(n(b))}j.resolve(a,[])}}}).fail(function(b,c){j.reject(a,[b,c])})});j.when().done(function(){i.storage.executeSql("DELETE FROM changed_values WHERE attrib=?",["object"],d)}).fail(n(b))}i.storage.rwTx().ready(function(a,b){i.storage.executeSql("SELECT object, source_id, update_type FROM changed_values where attrib = 'object' and sent=0",[],b).done(function(a,b){0!=b.rows.length&&c(a,b)})}).done(function(){b.resolve()}).fail(function(a,c){n(b)(a,c)})}).promise()}
var k=new i.Logger("SyncSource");this.storage=e;this.engine=f;this.id=b;this.name=c;this.partition=this.sync_priority=this.token=null;this.sync_type=d;this.metadata=null;this.backend_refresh_time=this.last_sync_success=this.last_sync_duration=this.last_deleted_size=this.last_inserted_size=this.last_updated=0;this.blob_attribs=this.associations=this.schema_version=this.schema=this.source_attribs=null;this.arAssociations=[];this.getAssociations=function(){return this.arAssociations};this.isTokenFromDb=
!0;this.errCode=i.ERRORS.ERR_NONE;this.serverError=this.error="";this.deletedCount=this.insertedCount=this.serverObjectsCount=this.curPageCount=this.totalCount=0;this.getAtLeastOnePage=!1;this.refreshTime=0;this.multipartItems=[];this.blobAttrs=[];this.schemaSource=!1;this.progressStep=-1;this.isEmptyToken=function(){return this.token==0};this.setToken=function(a){this.token=a;this.isTokenFromDb=!1};this.processToken=function(b){var c=this;return a.Deferred(function(a){b>1&&c.token==b?(c.setToken(b),
a.resolve()):(c.setToken(b),i.storage.executeSql("UPDATE sources SET token=? where source_id=?",[+c.token,c.id]).done(function(){a.resolve()}).fail(n(a)))}).promise()};this.parseAssociations=function(b){var c=this;if(b){var d="";a.each(b.split(","),function(a,b){d?(c.arAssociations.push(new g(d,b)),d=""):d=b})}};this.syncServerChanges=function(){var b=this;return a.Deferred(function(a){function c(){b.curPageCount=0;var f=i.protocol.getServerQueryUrl(""),g=b.engine.getClientId(),h=b.engine.getSyncPageSize(),
j=!b.isTokenFromDb&&b.token>1?b.token:null;k.info("Pull changes from server. Url: "+(f+d(b.name,g,h,j)));i.protocol.serverQuery(b.name,g,h,j).done(function(d,f){b.processServerResponse_ver3(f).done(function(){function d(){b.token&&b.engine.isContinueSync()?c():e||(e=!0,b.engine.isSchemaChanged()&&b.engine.stopSync(),a.resolve())}b.engine.getSourceOptions().getBoolProperty(b.id,"pass_through")?b.processToken(0).done(function(){d()}).fail(function(b,c){u(a)(b,c)}):d()}).fail(function(b,c){u(a)(b,c)})}).fail(function(c,
d,e){b.engine.stopSync();b.errCode=i.protocol.getErrCodeFromXHR(e);b.error=d;a.reject(B,d)})}function d(a,b,c,e){b="?client_id="+b+"&p_size="+c+"&version=3";b+=a?"&source_name="+a:"";return b+(e?"&token="+e:"")}k.info("Sync server changes source ID :"+b.id);c();var e=!1}).promise()};this.processServerResponse_ver3=function(b){var c=this;return a.Deferred(function(a){function d(){function g(){function d(){c.curPageCount>0&&c.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"");a.resolve()}
k.info("Got "+c.curPageCount+"(Processed: "+c.serverObjectsCount+") records of "+c.totalCount+" from server. Source: "+c.name+". Version: "+f.version);if(c.engine.isContinueSync()){f=b[e];e++;var h=f;void 0!=h["schema-changed"]?(c.engine.setSchemaChanged(!0),d()):c.processServerErrors(h)?d():i.storage.rwTx().ready(function(b,e){function f(){function b(){void 0!=h.links&&c.engine.isContinueSync()&&c.processSyncCommand("links",h.links,!0,e);void 0!=h["delete"]&&c.engine.isContinueSync()&&c.processSyncCommand("delete",
h["delete"],!0,e);void 0!=h.insert&&c.engine.isContinueSync()&&c.processSyncCommand("insert",h.insert,!0,e);c.getNotify().fireObjectsNotification();d()}void 0!=h.metadata&&c.engine.isContinueSync()?i.storage.executeSql("UPDATE sources SET metadata=? WHERE source_id=?",[h.metadata,c.id],e).done(function(){b()}).fail(n(a)):b()}c.engine.getSourceOptions().getBoolProperty(c.id,"pass_through")?c.schemaSource||i.storage.executeSql("DELETE FROM object_values WHERE source_id=?",[c.id],e).done(function(){f()}).fail(n(a)):
f()}).done(function(){a.resolve()}).fail(function(b,c){n(a)(b,c)})}else d()}f=b[e];void 0!=f.source&&e++;f=b[e];if(void 0!=f.count)e++,c.curPageCount=+f.count;f=b[e];if(void 0!=f.refresh_time)e++,c.refreshTime=+f.refresh_time;f=b[e];void 0!=f.progress_count&&e++;f=b[e];if(void 0!=f.total_count)e++,c.totalCount=+f.total_count;c.token==0?i.storage.executeSql("DELETE FROM changed_values where source_id=? and sent>=3",[c.id]).done(function(){g()}).fail(n(a)):g()}var e=0,f=null,f=b[e];if(void 0!=f.version&&
(e++,f.version!=i.protocol.getVersion())){k.error("Sync server send data with incompatible version. Client version: "+i.protocol.getVersion()+"; Server response version: "+f.version+". Source name: "+c.name);c.engine.stopSync();c.errrCode=i.ERRORS.ERR_UNEXPECTEDSERVERRESPONSE;a.reject(c.errCode,"Sync server send data with incompatible version.");return}f=b[e];void 0!=f.token?(e++,c.processToken(+f.token).done(function(){d()}).fail(function(b,d){a.reject(c.errCode,d)})):d()}).promise()};this.processSyncCommand=
function(b,c,d,e){var f=this;return a.Deferred(function(g){var h=i.deferredMapOn(c);a.each(c,function(c,g){function j(){h.resolve(c,[e]);if(f.sync_type!="none"&&d){var a=f.getNotify().incLastSyncObjectCount(f.id);f.progressStep>0&&a%f.progressStep==0&&f.getNotify().fireSyncNotification(this,!1,i.ERRORS.ERR_NONE,"")}}f.engine.isContinueSync()&&(f.schemaSource||a.each(g,function(a,d){f.engine.isContinueSync()&&f.processServerCmd_Ver3(b,c,a,d,e).done(function(){j()}).fail(function(a,b){k.error("Sync of server changes failed for "+
f.name+"; object: "+c,b);h.reject(c,[a,b])})}))});h.when().done(function(){g.resolve(e)}).fail(u(g))}).promise()};this.processServerCmd_Ver3=function(b,c,d,e,f){var g=this;return a.Deferred(function(a){var j=new h(d,e);if(b=="insert"){i.storage.executeSql("SELECT source_id FROM object_values WHERE object=? and attrib=? and source_id=? LIMIT 1 OFFSET 0",[c,j.m_strAttrib,g.id],f).done(function(b,d){0==d.rows.length?i.storage.executeSql("INSERT INTO object_values (attrib, source_id, object, value) VALUES(?,?,?,?)",
[j.m_strAttrib,g.id,c,j.m_strValue],b).done(function(){k()}).fail(n(a)):i.storage.executeSql("UPDATE object_values SET value=? WHERE object=? and attrib=? and source_id=?",[j.m_strValue,c,j.m_strAttrib,g.id],b).done(function(b){g.sync_type!="none"?i.storage.executeSql("UPDATE changed_values SET sent=4 where object=? and attrib=? and source_id=? and sent>1",[c,j.m_strAttrib,g.id],b).done(function(){k()}).fail(n(a)):k()}).fail(n(a))}).fail(n(a));var k=function(){if(g.sync_type!="none")g.getNotify().onObjectChanged(g.id,
c,i.notify.ACTIONS.update);g.insertedCount++;a.resolve(f)}}else b=="delete"?i.storage.executeSql("DELETE FROM object_values where object=? and attrib=? and source_id=?",[c,j.m_strAttrib,g.id],f).done(function(b){g.sync_type!="none"?(g.getNotify().onObjectChanged(g.id,c,i.notify.ACTIONS["delete"]),i.storage.executeSql("UPDATE changed_values SET sent=3 where object=? and attrib=? and source_id=?",[c,j.m_strAttrib,g.id],b).done(function(){g.deletedCount++;a.resolve(b)}).fail(n(a))):(g.deletedCount++,
a.resolve(b))}).fail(n(a)):b=="links"&&g.processAssociations(c,j.m_strValue,f).done(function(b){i.storage.executeSql("UPDATE object_values SET object=? where object=? and source_id=?",[j.m_strValue,c,g.id],b).done(function(){i.storage.executeSql("UPDATE changed_values SET object=?,sent=3 where object=? and source_id=?",[j.m_strValue,c,g.id],b).done(function(){g.getNotify().onObjectChanged(g.id,c,i.notify.ACTIONS.create);a.resolve(b)}).fail(n(a))}).fail(n(a))}).fail(u(a))}).promise()};this.processAssociations=
function(b,c,d){var e=this;return a.Deferred(function(a){if(e.associations.length==0)a.resolve();else{for(var g=i.deferredMapOn(e.associations),h=0;h<e.associations.length;h++){var j=f.findSourceBy("name",e.associations[h].m_strSrcName);j&&j.updateAssociation(b,c,e.associations[h].m_strAttrib,d).done(function(){g.resolve(h,[])}).fail(function(a,b){g.reject(h,[a,b])})}g.when().done(function(){a.resolve(d)}).fail(u(a))}}).promise()};this.updateAssociation=function(b,c,d,e){var f=this;return a.Deferred(function(a){function g(){i.storage.executeSql("UPDATE changed_values SET value=? where attrib=? and source_id=? and value=?",
[c,d,f.id,b],e).done(function(){a.resolve(e)}).fail(n(a))}f.schemaSource?g():i.storage.executeSql("UPDATE object_values SET value=? where attrib=? and source_id=? and value=?",[c,d,f.id,b],e).done(function(){g()}).fail(n(a))}).promise()};this.processServerErrors=function(b){function c(d){f=!0;e.ErrCode=i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(b[d],function(a,b){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(a)+"][message]="+encodeURI(b.message)})}function d(c){f=!0;e.ErrCode=
i.ERRORS.ERR_CUSTOMSYNCSERVER;a.each(b[c],function(b,d){b.match(/-error$/i)?(b=b.substring(0,b.length-6),e.serverError+=e.serverError?"&":"",e.serverError+="server_errors["+encodeURI(c)+"]["+encodeURI(b)+"][message]="+encodeURI(d.message)):a.each(d,function(a,d){e.serverError+=e.serverError?"&":"";e.serverError+="server_errors["+encodeURI(c)+"]["+encodeURI(b)+"][attributes]["+encodeURI(a)+"]="+encodeURI(d)})})}var e=this,f=!1;a.each(b,function(a){a.match(/^(source|search)-error$/i)?c(a):a.match(/-error$/i)&&
d(a)});return f};this.syncClientChanges=function(){var b=this;return a.Deferred(function(a){function c(){b.isPendingClientChanges().done(function(c){d&&c?(k.info("Server does not sent created items. Stop sync."),b.engine.setState(w.stop),a.resolve(d)):i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? LIMIT 1 OFFSET 0",[b.id]).done(function(c,e){var f=!1;(f=e.rows&&e.rows.length&&0<e.rows.length)?b.doSyncClientChanges().done(function(){d=!1;a.resolve(d)}).fail(u(a)):a.resolve(d)}).fail(n(a))}).fail(n(a))}
var d=!1;b.isPendingClientChanges().done(function(e){e?(k.info("Client has unconfirmed created items. Call server to update them."),b.syncServerChanges().done(function(){d=!0;c()}).fail(u(a))):c()}).fail(n(a))}).promise()};this.isPendingClientChanges=function(){var b=this;return a.Deferred(function(a){i.storage.executeSql("SELECT object FROM changed_values WHERE source_id=? and update_type='create' and sent>1  LIMIT 1 OFFSET 0",[b.id]).done(function(b,c){a.resolve(c.rows&&c.rows.length&&0<c.rows.length)}).fail(function(b,
c){a.reject(b,c)})}).promise()};this.doSyncClientChanges=function(){var b=this;return a.Deferred(function(c){function d(){function e(){var d=i.deferredMapOn(f);a.each(f,function(a,c){b.engine.isContinueSync()&&c?a=="create"?b.storage.executeSql("UPDATE changed_values SET sent=2 WHERE source_id=? and update_type=? and sent=1",[b.id,a]).done(function(){d.resolve(a,[])}).fail(function(b,c){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+c])}):b.storage.executeSql("DELETE FROM changed_values WHERE source_id=? and update_type=? and sent=1",
[b.id,a]).done(function(){d.resolve(a,[])}).fail(function(b,c){d.reject(a,[i.ERRORS.ERR_RUNTIME,"db access error: "+c])}):d.resolve(a,[])});d.when().done(function(){b.multipartItems=[];b.blobAttrs=[];c.resolve()}).fail(u(c))}g?(k.info("Push client changes to server. Source: "+b.name),k.trace("Push body: "+a.toJSON(h)),b.multipartItems.length>0?e():i.protocol.postData(h).done(function(){e()}).fail(function(a,d,e){b.engine.setState(i.states.stop);b.errCode=i.protocol.getErrCodeFromXHR(e);b.errCode=
q(d)?i.ERRORS.ERR_NOSERVERRESPONSE:b.errCode;b.error=d;c.reject(b.errCode,b.error)})):e()}var e=["create","update","delete"],f={};b.multipartItems=[];b.blobAttrs=[];var g=!1,h={source_name:b.name,client_id:b.engine.getClientId()},j=i.deferredMapOn(e);a.each(e,function(a,c){b.engine.isContinueSync()?(g=f[c]=!0,b.makePushBody_Ver3(c,!0).done(function(b){h[c]=b;j.resolve(a,[])}).fail(function(b,c){j.reject(a,[b,c])})):j.resolve(a,[])});j.when().done(function(){d()}).fail(u(c))}).promise()};this.makePushBody_Ver3=
function(b,c){var d=this;return a.Deferred(function(a){function e(){function g(e,h){if(h.rows&&h.rows.length&&0==h.rows.length)a.resolve(f);else{for(var j=0;j<h.rows.length;j++){var k=h.rows.item(j).attrib,l=h.rows.item(j).object,m=h.rows.item(j).value;h.rows.item(j);f[l]||(f[l]={});f[l][k]=m}c&&i.storage.executeSql("UPDATE changed_values SET sent=1 WHERE source_id=? and update_type=? and sent=0",[d.id,b]).done(function(){a.resolve(f)}).fail(n(a))}}i.storage.executeSql("SELECT attrib, object, value, attrib_type FROM changed_values where source_id=? and update_type =? and sent<=1 ORDER BY object",
[d.id,b]).done(function(a,b){g(a,b)}).fail(n(a))}var f={};c?j().done(function(){e()}).fail(n(a)):e()}).promise()};this.sync=function(){var b=this;return a.Deferred(function(a){function c(e,f){b.engine.stopSync();d();a.reject(e,f)}function d(){var a=Date.now();i.storage.executeSql("UPDATE sources set last_updated=?,last_inserted_size=?,last_deleted_size=?, last_sync_duration=?,last_sync_success=?, backend_refresh_time=? WHERE source_id=?",[a/1E3,b.getInsertedCount(),b.getDeletedCount(),a-e,b.getAtLeastOnePage?
1:0,b.refreshTime,b.id])}b.getNotify().reportSyncStatus("syncronizing"+b.name+"...",b.errCode,b.error);var e=Date.now();if(b.isTokenFromDb&&b.token>1)b.syncServerChanges().done(function(){d();a.resolve()}).fail(c);else{b.isEmptyToken()?b.processToken(1).done(function(){f()}).fail(c):f();var f=function(){b.syncClientChanges().done(function(e){e||b.syncServerChanges().done(function(){d();a.resolve()}).fail(c)}).fail(c)}}}).promise()};this.getNotify=function(){return this.engine.getNotify()};this.getInsertedCount=
function(){return this.insertedCount};this.getDeletedCount=function(){return this.deletedCount}}function n(a){return function(b,c){a.reject(i.ERRORS.ERR_RUNTIME,"db access error: "+c)}}function u(a){return function(b,c){a.reject(b,c)}}function L(a){this.id=a;this.token=this.session=null;this.reset=this.token_sent=0;this.last_sync_success=this.port=null}var i=RhoSync.rho,w={none:0,syncAllSources:1,syncSource:2,search:3,stop:4,exit:5},E={},x=[],W=new function(){var a={};this.setProperty=function(b,
c,d){var e=a[b];e||(e={},a[b]=e);e[c]=d||""};this.getProperty=function(b,c){var d=a[b];if(d)return d[c]||"";return""};this.getBoolProperty=function(a,b){var c=this.getProperty(a,b);return c=="1"||c=="true"}},P=null,y=w.none,Q=!1,B=i.ERRORS.ERR_NONE,F="",H=!1,A=null,R=null,K=new i.Logger("SyncEngine"),I=!1;a.extend(i,{engine:function(){return{Client:L,Source:Y,STATES:w,getSession:function(){return A},restoreSession:b,getSources:function(){return E},getSourcesArray:function(){return x},maxConfigSrcId:1,
login:g,logout:t,getState:D,setState:T,isSearch:m,doSyncAllSources:C,stopSync:r,getNotify:h,getSyncPageSize:function(){return 2E3},getClientId:function(){return R},getStartSourceId:U,findSourceBy:s,getSourceOptions:V,isNoThreadedMode:X,isSessionExist:M,isContinueSync:J,setSchemaChanged:function(a){H=a},isSchemaChanged:d,isStoppedByUser:function(){return I}}}()})})(jQuery);
(function(a){function h(a,d){this.params=a||"";this.removeAfterFire=d||!1;this.toString=function(){return"SyncNotification({removeAfterFire: "+this.removeAfterFire+"})"}}var m=RhoSync.rho,d={none:0,"delete":1,update:2,create:3};a.extend(m,{notify:{ACTIONS:d,SyncNotify:function(b){function t(b){if(!C[b])return"";var d="";a.each(j,function(a,b){d+="&create_error[][object]="+a;d+="&create_error[][error_message]="+b});return d}function g(a){var d=null;b.isSearch()?d=p:(a!=null&&(d=s[a.id]),d==null&&(d=
o));if(d==null&&!b.isNoThreadedMode())return null;return d!=null?d:v}function l(a){if(b.isNoThreadedMode())return!1;return a&&"function"==typeof a.params?a.params():!0}var k=new m.Logger("SyncNotify"),j={},z="",q="",C={},p=null,s={},o=null,v=h(),e={};this.cleanCreateObjectErrors=function(){C={}};this.fireObjectsNotification=function(){var b="";a.each(j,function(e,g){a.each(g,function(a,h){if(h!=d.none)b&&(b+="&rho_callback=1&"),h==d["delete"]?(b+="deleted[][object]="+a,b+="&deleted[][source_id]="+
e):h==d.update?(b+="updated[][object]="+a,b+="&updated[][source_id]="+e):h==d.create&&(b+="created[][object]="+a,b+="&created[][source_id]="+e),g[a]=d.none})});b&&l(new h("",!1),b)};this.onObjectChanged=function(a,e,g){if(z){var h=b.getSources()[z];if(h){var k=q;if("string"==typeof h)z=h,q=k.match(/^\{/)?k.substring(1,k.length-2):k;else if(h="number"==typeof h?h:h.id){var l=j[h];l&&(l={},j[h]=l);l[k]=d.none}}q=z=""}(a=j[a])&&e in a&&(a[e]=g)};this.onSyncSourceEnd=function(a,d){var e=d[a];b.getState()==
b.STATES.stop&&e.errCode!=m.ERRORS.ERR_NONE?g(e)!=null?this.fireSyncNotification(e,!0,e.errCode,""):this.fireAllSyncNotifications(!0,e.errCode,e.error,""):this.fireSyncNotification(e,!0,e.errCode,"");this.cleanCreateObjectErrors()};this.reportSyncStatus=function(){};this.fireAllSyncNotifications=function(a,d,e,h){b.getState()!=b.STATES.exit&&(d!=m.ERRORS.ERR_NONE&&!b.isSearch()&&this.reportSyncStatus("sync_failed_forall.",d,e),g(null)&&this.doFireSyncNotification(null,a,d,e,"",h))};this.fireSyncNotification=
function(a,d,e,g){if(b.getState()!=b.STATES.exit){if((g||e!=m.ERRORS.ERR_NONE)&&!b.isSearch())a!=null&&!g&&(g="sync_failed_for"+a.name+"."),this.reportSyncStatus(g,e,a!=null?a.error:"");this.doFireSyncNotification(a,d,e,"","","")}};this.doFireSyncNotification=function(a,d,h,j,o,p){if(!b.isStoppedByUser())try{var q=null,r="",s=d;if(q=g(a)){r="";a&&(r+="total_count="+a.totalCount,r+="&processed_count="+a.curPageCount,r+="&processed_objects_count="+(e[a.id]||0),r+="&cumulative_count="+a.serverObjectsCount,
r+="&source_id="+a.id,r+="&source_name="+a.name);r+=(r?"&":"")+(o||"sync_type=incremental");r+="&status=";if(d){if(h==m.ERRORS.ERR_NONE)r+=!a&&!o?"complete":"ok";else{if(b.isStoppedByUser())h=m.ERRORS.ERR_CANCELBYUSER;r+="error";r+="&error_code="+h;j?r+="&error_message="+j:a&&(r+="&error_message="+a.error);p?r+="&"+p:a&&a.serverError&&(r+="&"+a.serverError)}a&&(r+=t(a.id))}else r+="in_progress";r+="&rho_callback=1";(s=s&&q.removeAfterFire)&&this.clearNotification(a);k.info("Fire notification. Source: "+
(a?a.name:"")+"; "+q.toString());l(q,r)&&this.clearNotification(a)}}catch(v){k.error("Fire notification failed.",v)}};this.setNotification=function(a,b){a&&this.setSyncNotification(a.id,b)};this.setSyncNotification=function(a,b){k.info("Set notification. Source ID: "+a+";"+(b?b.toString():""));a==-1?o=b:s[a]=b};this.clearNotification=function(a){k.info("Clear notification. Source: "+(a?a.name:""));b.isSearch()?p=null:s[a.id]=null};this.clearSyncNotification=function(a){k.info("Clear notification. Source ID: "+
a);a==-1?o=null:s[a]=null};this.cleanLastSyncObjectCount=function(){e={}};this.incLastSyncObjectCount=function(a){var b=e[a]||0;b+=1;return(e[a]=b)||0};this.callLoginCallback=function(a,d,e){b.isStoppedByUser()||(d="error_code="+d,d+="&error_message="+(e!=null?e:""),d+="&rho_callback=1",k.info("Login callback: "+a.toString()+". Body: "+d),l(a,d))}},SyncNotification:h,byEvent:function(b){a(window).trigger(jQuery.Event(b),a.makeArray(arguments).slice(1))}}});a.extend(RhoSync,{SyncNotification:h})})(jQuery);
